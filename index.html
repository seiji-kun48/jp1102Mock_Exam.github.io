<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPN1102 Exam Simulator (Complete Edition)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .jp-text { font-family: 'Noto Sans JP', sans-serif; line-height: 2.5; }
        
        /* Ruby Styling */
        ruby { font-family: 'Noto Sans JP', sans-serif; ruby-align: center; }
        rt { font-size: 0.6em; color: #6b7280; font-weight: normal; user-select: none; }
        .hide-furigana rt { display: none; }
        .hide-furigana ruby { ruby-position: unset; }

        .no-select { user-select: none; }
        
        /* Inline Input Styling */
        .inline-input {
            display: inline-block;
            border-bottom: 2px solid #6366f1;
            background: #f9fafb;
            text-align: center;
            padding: 0 0.25rem;
            margin: 0 0.25rem;
            border-radius: 0.25rem 0.25rem 0 0;
            outline: none;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
            min-width: 80px;
            color: #4338ca;
            font-weight: bold;
        }
        .inline-input:focus {
            background: #e0e7ff;
            border-color: #4338ca;
        }
        /* Sticky Header Fix */
        header { z-index: 50; }
        
        /* Hide Scrollbar for Nav */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- CONFIGURATION ---
        const EXAM_CONFIG = {
            duration: 120 * 60, // 2 ชั่วโมง
            counts: {
                part1: 15, // คำช่วย
                part2: 5,  // ผันรูป
                part3: 7,  // ถาม-ตอบ
                part4: 5,  // แยกประโยค
                part5: 6, // แก้ประโยค
                part6: 5, // แปล
                part7: 5  // ปรนัย
            }
        };

        // --- HELPER FUNCTION: Randomize Array (FIXED BUG HERE) ---
        const getRandomQuestions = (questions, count) => {
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        };

        // --- QUESTION POOL (UPDATED FROM PDF) ---
        const QUESTION_POOL = {
            part1: {
                title: "Part 1: เติมคำช่วย (Joshi)",
                instruction: "จงเติมคำช่วยที่ถูกต้องลงในช่องว่าง",
                type: "fill-in-inline", 
                delimiter: /（　）/,   
                questions: [
                    { q: "あれ（　）友達（　）撮った写真です。", a: "あれ（は）友達（が）撮った写真です。" },
                    { q: "元気なとき、毎日、お酒（　）ワインを飲まない（　） 思います。", a: "元気なとき、毎日、お酒（や/か）ワインを飲まない（と） 思います。" },
                    { q: "京都へ行く人（　）ミラーさんです。", a: "京都へ行く人（は）ミラーさんです。" },
                    { q: "これはミラーさんが住んでいたうち（　）近いです。", a: "これはミラーさんが住んでいたうち（に）近いです。" },
                    { q: "私は彼（　）パソコン（　）教えてもらいました。", a: "私は彼（に）パソコン（を）教えてもらいました。" },
                    { q: "部長（　）資料（　）送っていただきました。", a: "部長（に）資料（を）送っていただきました。" },
                    { q: "お金（　）あったら、旅行（　）します。", a: "お金（が）あったら、旅行（を）します。" },
                    { q: "明日、会議（　）意見（　）言うつもりです。", a: "明日、会議（で）意見（を）言うつもりです。" },
                    { q: "右（　）曲がる（　）、郵便局があります。", a: "右（へ/に）曲がる（と）、郵便局があります。" },
                    { q: "図書館（　）本（　）借りるとき、カードが要ります。", a: "図書館（で）本（を）借りるとき、カードが要ります。" },
                    { q: "日曜日（　）、働きます。", a: "日曜日（でも）、働きます。" },
                    { q: "友達（　）約束の時間（　）来なかったら、どうしますか。", a: "友達（が）約束の時間（に）来なかったら、どうしますか。" },
                    { q: "私（　）留学すること（　）できなくても、頑張ります。", a: "私（は）留学すること（が）できなくても、頑張ります。" },
                    { q: "彼（　）日本語（　）上手（　）なくても、日本人と話します。", a: "彼（は）日本語（が）上手（じゃ）なくても、日本人と話します。" },
                    { q: "ミラーさん（　）私（　）傘（　） 貸してくれました。", a: "ミラーさん（は）私（に）傘（を） 貸してくれました。" },
                    { q: "私は家族（　）日本へ行きたいです。", a: "私は家族（と）日本へ行きたいです。" },
                    { q: "お腹が空きましたから、何（　）食べたいです。", a: "お腹が空きましたから、何（か）食べたいです。" },
                    { q: "神戸ヘインド料理（　）食べ（　）行きます。", a: "神戸ヘインド料理（を）食べ（に）行きます。" },
                    { q: "ここ（　）タバコ（　）吸ってはいけません。", a: "ここ（で）タバコ（を）吸ってはいけません。" },
                    { q: "市役所の電話番号（　）知っていますか。", a: "市役所の電話番号（を）知っていますか。" },
                    { q: "私は大阪（　）住んでいます。", a: "私は大阪（に）住んでいます。" },
                    { q: "ここ（　）入ってはいけません。", a: "ここ（に）入ってはいけません。" },
                    { q: "京都駅からバス（　）乗ってください。", a: "京都駅からバス（に）乗ってください。" },
                    { q: "馬（　）乗ったこと（　）あります。", a: "馬（に）乗ったこと（が）あります。" },
                    { q: "趣味は音楽（　）聞くこと（　）です。", a: "趣味は音楽（を）聞くこと（です）です。" },
                    { q: "寝る前（　）、本（　）読みます。", a: "寝る前（に）、本（を）読みます。" },
                    { q: "日本（　）来る前（　）、日本語（　）勉強しました。", a: "日本（へ/に）来る前（に）、日本語（を）勉強しました。" },
                    { q: "ぜひ遊び（　）来てください。", a: "ぜひ遊び（に）来てください。" },
                    { q: "日曜日、テニス（　）したり、映画（　）見たりします。", a: "日曜日、テニス（を）したり、映画（を）見たりします。" },
                    { q: "テレザちゃんは背（　）高くなりました。", a: "テレザちゃんは背（が）高くなりました。" },
                    { q: "このボタン（　）押す（　）、お釣りが出ます。", a: "このボタン（を）押す（と）、お釣りが出ます。" },
                    { q: "橋（　）渡ります。", a: "橋（を）渡ります。" },
                    { q: "交差点（　）右（　）曲がります。", a: "交差点（を）右（へ/に）曲がります。" },
                    { q: "公園（　）散歩します。", a: "公園（を）散歩します。" },
                    { q: "私は友達（　）漢字（　）読み方（　）教えてあげました。", a: "私は友達（に）漢字（の）読み方（を）教えてあげました。" },
                    { q: "明日、雨（　）降る（　）思います。", a: "明日、雨（が）降る（と）思います。" },
                    { q: "ミラーさんは来る（　）言いました。", a: "ミラーさんは来る（と）言いました。" },
                    { q: "約束（　）あります（　）、帰らなければなりません。", a: "約束（が）あります（から）、帰らなければなりません。" },
                    { q: "病院（　）行かなく（　）いいです。", a: "病院（へ/に）行かなく（ても）いいです。" },
                    { q: "2、3日、家（　）休んでください。", a: "2、3日、家（で）休んでください。" },
                    { q: "昨日、山（　）登りました。", a: "昨日、山（に）登りました。" },
                    { q: "日本語（　）話すこと（　）できます。", a: "日本語（を）話すこと（が）できます。" },
                    { q: "ここ（　）名前（　）書いてください。", a: "ここ（に）名前（を）書いてください。" },
                    { q: "辞書（　）貸して（　）ください。", a: "辞書（を）貸して（/て）ください。" },
                    { q: "妻（　）病気（　）とき、会社（　）休みます。", a: "妻（が）病気（の）とき、会社（を）休みます。" },
                    { q: "時間（　）ない（　）、テレビ（　）見ません。", a: "時間（が）ない（と）、テレビ（を）見ません。" },
                    { q: "もし1億円（　）あったら、いろいろな国（　）旅行したいです。", a: "もし1億円（が）あったら、いろいろな国（を）旅行したいです。" },
                    { q: "いくら安く（　）、グループ旅行（　）嫌いです。", a: "いくら安く（ても）、グループ旅行（は）嫌いです。" },
                    { q: "父（　）私（　）セーター（　）くれました。", a: "父（は）私（に）セーター（を）くれました。" },
                    { q: "私は山田さん（　）花（　）もらいました。", a: "私は山田さん（に/から）花（を）もらいました。" },
                    { q: "誰（　）手伝ってくれましたか。", a: "誰（が）手伝ってくれましたか。" },
                    { q: "母（　）料理（　）送ってくれました。", a: "母（が）料理（を）送ってくれました。" },
                    { q: "私（　）道（　）迷いましたから、交番（　）道（　）聞きました。", a: "私（は）道（に）迷いましたから、交番（で）道（を）聞きました。" },
                    { q: "カリナさん（　）かいた絵（　）好きです。", a: "カリナさん（が）かいた絵（が）好きです。" },
                    { q: "彼（　）生まれた所（　）知っていますか。", a: "彼（が）生まれた所（を）知っていますか。" },
                    { q: "朝ごはん（　）食べる時間（　）ありません。", a: "朝ごはん（を）食べる時間（が）ありません。" },
                    { q: "日本（　）物価（　）高い（　）思います。", a: "日本（の）物価（が）高い（と）思います。" },
                    { q: "首相（　）来月アメリカ（　）行く（　）言いました。", a: "首相（は）来月アメリカ（へ）行く（と）言いました。" },
                    { q: "明日、パーティー（　）行く（　）しょう？", a: "明日、パーティー（に）行く（で）しょう？" },
                    { q: "東京（　）サッカー（　）試合（　）あります。", a: "東京（で）サッカー（の）試合（が）あります。" },
                    { q: "会議（　）何か意見（　）言いましたか。", a: "会議（で）何か意見（を）言いましたか。" },
                    { q: "ちょっとビール（　）飲みませんか。", a: "ちょっとビール（でも）飲みませんか。" },
                    { q: "約束（　）時間（　）間に合わない（　）、どうしますか。", a: "約束（の）時間（に）間に合わない（かったら）、どうしますか。" },
                    { q: "音（　）小さいです。", a: "音（が）小さいです。" },
                    { q: "道（　）渡るとき、車（　）気をつけます。", a: "道（を）渡るとき、車（に）気をつけます。" },
                    { q: "佐藤さん（　）私（　）クリスマスカード（　）くれました。", a: "佐藤さん（は）私（に）クリスマスカード（を）くれました。" },
                    { q: "私は木村さん（　）本（　）貸してあげました。", a: "私は木村さん（に）本（を）貸してあげました。" },
                    { q: "山田さん（　）お母さん（　）病院（　）連れて行きました。", a: "山田さん（は）お母さん（を）病院（へ）連れて行きました。" },
                    { q: "雨（　）降っても、出かけます。", a: "雨（が）降っても、出かけます。" },
                    { q: "暇（　）だったら、手伝ってください。", a: "暇（/）だったら、手伝ってください。" },
                    { q: "日本語（　）勉強（　）どうですか。", a: "日本語（の）勉強（は）どうですか。" },
                    { q: "薬（　）飲まなければなりません。", a: "薬（を）飲まなければなりません。" },
                    { q: "ここ（　）写真（　）撮らないでください。", a: "ここ（で）写真（を）撮らないでください。" },
                    { q: "パスポート（　）見せなく（　）いいです。", a: "パスポート（を）見せなく（ても）いいです。" }
                ]
            },
            part2: {
                title: "Part 2: ผันรูป (Conjugation)",
                instruction: "เปลี่ยนคำในวงเล็บให้อยู่ในรูปที่ถูกต้อง",
                type: "fill-in-inline",
                delimiter: /_______/, 
                questions: [
                    { q: "おいしいですから、（食{た}べます → _______ ）ください。", a: "食べて" },
                    { q: "これはミラーさんが（作{つく}ります → _______ ）料理{りょうり}です。", a: "作った" },
                    { q: "（飲{の}みます → _______ ）たいです。", a: "飲み" },
                    { q: "ここに車を（止{と}めます → _______ ）ないでください。", a: "止め" },
                    { q: "薬を（飲{の}みます → _______ ）なければなりません。", a: "飲ま" },
                    { q: "明日、来（来{く}ます → _______ ）なくてもいいです。", a: "来" },
                    { q: "土曜日までに本を（返{かえ}します → _______ ）なければなりません。", a: "返さ" },
                    { q: "ピアノを（弾{ひ}きます → _______ ）ことができます。", a: "弾く" },
                    { q: "趣味は写真を（撮{と}ります → _______ ）ことです。", a: "撮る" },
                    { q: "寝る（寝{ね}ます → _______ ）前に、お祈りをします。", a: "寝る" },
                    { q: "馬に（乗{の}ります → _______ ）ことがありますか。", a: "乗った" },
                    { q: "日曜日{にちようび}は掃除{そうじ}（します → _______ ）たり、洗濯（します → _______ ）たりします。", a: "し / し" },
                    { q: "日本語が（上手{じょうず}です → _______ ）なりました。", a: "上手に" },
                    { q: "明日、雨が（降{ふ}ります → _______ ）と思います。", a: "降る" },
                    { q: "彼は（行{い}きます → _______ ）と言いました。", a: "行く" },
                    { q: "明日、パーティーに（行{い}きます → _______ ）でしょう？", a: "行く" },
                    { q: "これはミラーさんが（住{す}みます → _______ ）いたうちです。", a: "住んで" },
                    { q: "私は彼が（生{う}まれます → _______ ）所を知っています。", a: "生まれた" },
                    { q: "友達が（来{く}ます → _______ ）前に、部屋を掃除します。", a: "来る" },
                    { q: "ご飯を（食{た}べます → _______ ）たら、元気になります。", a: "食べ" },
                    { q: "時間が（ありません → _______ ）かったら、テレビを見ません。", a: "な" },
                    { q: "（安{やす}いです → _______ ）かったら、パソコンを買いたいです。", a: "安" },
                    { q: "（暇{ひま}です → _______ ）だったら、手伝ってください。", a: "暇" },
                    { q: "雨が（降{ふ}ります → _______ ）ても、洗濯します。", a: "降っ" },
                    { q: "（安{やす}いです → _______ ）くても、私はグループ旅行が嫌いです。", a: "安" }
                ]
            },
            part3: {
                title: "Part 3: ตอบคำถาม (Q&A)",
                instruction: "ตอบคำถามให้สมบูรณ์ (คิดคำตอบในใจ หรือพิมพ์เพื่อตรวจสอบ)",
                type: "fill-in",
                questions: [
                    { q: "どんなとき、お皿を洗わなければなりませんか。", a: "ご飯を食べたとき、お皿を洗わなければなりません。" },
                    { q: "紅茶に砂糖を入れないとどうなりますか。", a: "おいしくなくなります。" },
                    { q: "今、彼が食べる料理はどれですか。", a: "あなたが作る料理です。" },
                    { q: "夏休みはどこかへ行きましたか。", a: "いいえ、どこへも行きませんでした。" },
                    { q: "明日、暇だったら、何をしますか。", a: "（例えば）映画を見ます。" },
                    { q: "日本語が分からなかったら、どうしますか。", a: "先生に聞きます。/辞書で調べます。" },
                    { q: "雨が降っても、出かけますか。", a: "はい、(雨が降っても) 出かけます。" },
                    { q: "誰に日本語を教えてもらいましたか。", a: "日本人の先生に教えてもらいました。" },
                    { q: "誰が手伝ってくれましたか。", a: "ミラーさんが手伝ってくれました。" },
                    { q: "誰に地図を描いてあげましたか。", a: "佐藤さんに描いてあげました。" },
                    { q: "趣味は何ですか。", a: "（私の趣味は） 写真を撮ることです。" },
                    { q: "日本へ行ったことがありますか。", a: "はい、(行ったことが)あります。" },
                    { q: "日曜日、何をしますか。", a: "映画を見たり、音楽を聞いたりします。" },
                    { q: "日本語が上手になりましたか。", a: "はい、上手になりました。" },
                    { q: "日本の物価についてどう思いますか。", a: "高いと思います。" },
                    { q: "首相(นายกฯ)は来月、何をすると言いましたか。", a: "アメリカへ行くと言いました。" },
                    { q: "明日、パーティーに行くでしょう？", a: "ええ、行きます。" },
                    { q: "東京で何がありますか。", a: "サッカーの試合があります。" },
                    { q: "このボタンを押すと、どうなりますか。", a: "お釣りが出ます。" },
                    { q: "道を渡るとき、何をしなければなりませんか。", a: "右と左を見なければなりません。" },
                    { q: "眠い時、どうしますか。", a: "コーヒーを飲みます。/ 顔を洗います。" },
                    { q: "ここで写真を撮ってもいいですか。", a: "いいえ、撮ってはいけません。" },
                    { q: "もう昼ご飯を食べましたか。", a: "いいえ、まだ食べていません。" },
                    { q: "どうして昨日学校を休みましたか。", a: "病気でしたから。" },
                    { q: "今、何が一番欲しいですか。", a: "車が一番欲しいです。" },
                    { q: "週末はどこへ行きたいですか。", a: "海へ行きたいです。" },
                    { q: "図書館へ何をしに行きますか。", a: "本を借りに行きます。" },
                    { q: "タクシーを呼びましょうか。", a: "ええ、お願いします。 / いいえ、けっこうです。" },
                    { q: "市役所の電話番号を知っていますか。", a: "いいえ、知りません。" },
                    { q: "どこで乗りますか。", a: "京都駅で乗ります。" },
                    { q: "明日、残業しなければなりませんか。", a: "いいえ、残業しなくてもいいです。" },
                    { q: "日曜日でも、早く起きなければなりませんか。", a: "はい、早く起きなければなりません。" },
                    { q: "お金がたくさんあったら、何をしたいですか。", a: "世界旅行をしたいです。" },
                    { q: "約束の時間に友達が来なかったら、どうしますか。", a: "帰ります。" },
                    { q: "漢字の読み方が分からないとき、どうしますか。", a: "先生に聞きます。" }
                ]
            },
            part4: {
                title: "Part 4: แยกประโยคหลัก/ย่อย",
                instruction: "ระบุประโยคหลัก (Main) และส่วนขยาย (Sub/Modifier)",
                type: "fill-in",
                questions: [
                    { q: "これはシャオ先生が書いた絵です。", a: "Main: これは絵です。 / Sub: シャオ先生が書いた" },
                    { q: "今日、きのう借りた本を返します。", a: "Main: 今日、本を返します。 / Sub: きのう借りた" },
                    { q: "京都へ行く人はミラーさんです。", a: "Main: 人はミラーさんです。 / Sub: 京都へ行く" },
                    { q: "これはミラーさんが作ったケーキです。", a: "Main: これはケーキです。 / Sub: ミラーさんが作った" },
                    { q: "私が知らない歌です。", a: "Main: 歌です。 / Sub: 私が知らない" },
                    { q: "あそこに立っている女の人は誰ですか。", a: "Main: 女の人は誰ですか。 / Sub: あそこに立っている" },
                    { q: "先週デパートで買った靴は黒いです。", a: "Main: 靴は黒いです。 / Sub: 先週デパートで買った" },
                    { q: "彼が生まれた所を知っていますか。", a: "Main: 所を知っていますか。 / Sub: 彼が生まれた" },
                    { q: "ミラーさんが住んでいたうちに猫がいました。", a: "Main: うちに猫がいました。 / Sub: ミラーさんが住んでいた" },
                    { q: "図書館で借りた本を読みます。", a: "Main: 本を読みます。 / Sub: 図書館で借りた" },
                    { q: "私が欲しい車はドイツの車です。", a: "Main: 車はドイツの車です。 / Sub: 私が欲しい" },
                    { q: "昨日写真を撮った人は有名です。", a: "Main: 人は有名です。 / Sub: 昨日写真を撮った" },
                    { q: "私は朝ごはんを食べる時間がありません。", a: "Main: 私は時間がありません。 / Sub: 朝ごはんを食べる" },
                    { q: "友達と映画を見る約束があります。", a: "Main: 約束があります。 / Sub: 友達と映画を見る" },
                    { q: "市役所へ行く用事があります。", a: "Main: 用事があります。 / Sub: 市役所へ行く" },
                    { q: "妻が病気のとき、会社を休みます。", a: "Main: 会社を休みます。 / Sub: 妻が病気の(とき)" },
                    { q: "友達が来る前に、部屋を掃除します。", a: "Main: 部屋を掃除します。 / Sub: 友達が来る(前に)" },
                    { q: "私は母に料理を作ってあげました。", a: "Main: (ประโยคความเดียว) 私は母に料理を作ってあげました。" },
                    { q: "佐藤さんは私にクリスマスカードをくれました。", a: "Main: (ประโยคความเดียว) 佐藤さんは私にクリスマスカードをくれました。" },
                    { q: "私は山田さんに図書館の電話番号を教えてもらいました。", a: "Main: (ประโยคความเดียว) 私は山田さんに図書館の電話番号を教えてもらいました。" },
                    { q: "誰が手伝ってくれましたか。", a: "Main: (ประโยคความเดียว)" },
                    { q: "カリナさんが書いた絵が好きです。", a: "Main: 私は絵が好きです。 / Sub: カリナさんが書いた" },
                    { q: "彼女が着ている服は新しいです。", a: "Main: 服は新しいです。 / Sub: 彼女が着ている" },
                    { q: "昨日買った辞書はどこですか。", a: "Main: 辞書はどこですか。 / Sub: 昨日買った" },
                    { q: "友達がアルバイトをしているレストランで食べます。", a: "Main: レストランで食べます。 / Sub: 友達がアルバイトをしている" }
                ]
            },
            part5: {
                title: "Part 5: แก้ไขประโยค (Error Correction)",
                instruction: "แก้ไขประโยคที่ผิดไวยากรณ์ให้ถูกต้อง",
                type: "fill-in",
                questions: [
                    { q: "来年、卒業するとき、父の会社で働きました。", a: "来年、卒業したとき（または卒業してから）、父の会社で働きます。" },
                    { q: "このかばんは母に買ってあげたかばんです。（บริบท: กระเป๋าที่แม่ซื้อให้ฉัน）", a: "このかばんは母が買ってくれたかばんです。" },
                    { q: "安いでおいしいです。", a: "安くて、おいしいです。" },
                    { q: "ここで写真を撮りないでください。", a: "ここで写真を撮らないでください。" },
                    { q: "日本へ行った前に、日本語を勉強しました。", a: "日本へ来る前に、日本語を勉強しました。" },
                    { q: "明日、雨が降りますと思います。", a: "明日、雨が降ると思います。" },
                    { q: "馬に乗りますことがあります。", a: "馬に乗ったことがあります。" },
                    { q: "部屋を入ります。", a: "部屋に入ります。" },
                    { q: "歌を歌うのができます。", a: "歌を歌うことができます。" },
                    { q: "暑いとき、泳ぎに行きます。", a: "暑いとき、泳ぎに行きます。（Adj-i หน้า Toki ไม่ต้องมี no）" },
                    { q: "このボタンを押してと、切符が出ます。", a: "このボタンを押すと、切符が出ます。" },
                    { q: "日曜日はテニスをして、映画を見たりします。", a: "日曜日はテニスをしたり、映画を見たりします。" },
                    { q: "彼は親切くて、ハンサムです。", a: "彼は親切で、ハンサムです。" },
                    { q: "昨日は雨くないでした。", a: "昨日は雨じゃありませんでした。" },
                    { q: "時間がありませんから、新聞を読みません。（เปลี่ยนเป็นรูป Plain เชื่อม kara）", a: "時間がないから、新聞を読みません。" },
                    { q: "雨が降ると、出かけません。（ตั้งใจไม่ออกไป）", a: "雨が降ったら、出かけません。" },
                    { q: "時間があったら、映画を見に行きますか。（ชวน）", a: "時間があったら、映画を見に行きませんか/行きましょうか。" },
                    { q: "明日、天気がいいと、洗濯します。（ตั้งใจ）", a: "明日、天気がよかったら、洗濯します。" },
                    { q: "私は花に水をくれました。", a: "私は花に水をやりました。" },
                    { q: "パスポートをなくすとき、どうしますか。", a: "パスポートをなくしたとき、どうしますか。" },
                    { q: "友達が来ないたら、どうしますか。", a: "友達が来なかったら、どうしますか。" },
                    { q: "彼は来ますと言いました。", a: "彼は来ると言いました。" },
                    { q: "元気でも、薬を飲まなければなりません。（บริบท: ถ้าสบายดี ไม่ต้องกินยา）", a: "元気だったら、薬を飲まなくてもいいです。" },
                    { q: "いくら安かったら、買いません。", a: "いくら安くても、買いません。" },
                    { q: "ミラーさんは親切だと思います。", a: "ミラーさんは親切だと思います。（Na-adj: da to omoimasu）" },
                    { q: "部屋はきれいかったら、借りたいです。", a: "部屋がきれいだったら、借りたいです。" },
                    { q: "明日、暇だと、遊びに行きましょう。", a: "明日、暇だったら、遊びに行きましょう。" },
                    { q: "私は山田さんに本を貸してくれました。（ฉันให้เขา）", a: "私は山田さんに本を貸してあげました。" },
                    { q: "財布を落とすとき、交番へ行きます。", a: "財布を落としたとき、交番へ行きます。" },
                    { q: "ミラーさんは日本語が話すことができます。", a: "ミラーさんは日本語を話すことができます。（または日本語が話せます）" }
                ]
            },
            part6: {
                title: "Part 6: การแปล (Translation)",
                instruction: "แปลประโยคต่อไปนี้เป็นภาษาญี่ปุ่น",
                type: "fill-in",
                questions: [
                    { q: "พี่สาวบอกว่านาฬิกาเรือนนั้นแพง", a: "姉はその時計は高いと言いました。" },
                    { q: "วันพรุ่งนี้จะนำขนมที่ซื้อไปให้พี่ชายที่ทำงานที่บริษัทแห่งนั้น (แปลเป็นรูปธรรมดา)", a: "明日、その会社で働いている兄に買ったお菓子をあげる。" },
                    { q: "คุณมิลเลอร์พูดว่า \"พรุ่งนี้จะไปโตเกียว\"", a: "ミラーさんは「明日、東京へ行きます」と言いました。" },
                    { q: "ถ้าฝนตก จะไม่ออกไปข้างนอก", a: "雨が降ったら、出かけません。" },
                    { q: "ถึงแม้ว่าจะง่วงนอน ก็ต้องทำการบ้าน", a: "眠くても、宿題をしなければなりません。" },
                    { q: "(ฉัน)ได้รับนาฬิกาเรือนนี้มาจากพี่สาว", a: "姉にこの時計をもらいました。" },
                    { q: "(ฉัน) ซื้อจักรยานให้ลูกชาย", a: "息子に自転車を買ってあげました。" },
                    { q: "คุณแม่ส่งพัสดุมาให้ (ฉัน)", a: "母は(私に) 荷物を送ってくれました。" },
                    { q: "คิดว่าราคาของที่ญี่ปุ่นแพง", a: "日本の物価は高いと思います。" },
                    { q: "ตอนที่เป็นเด็ก เคยว่ายน้ำที่แม่น้ำ", a: "子供のとき、川で泳いだことがあります。" },
                    { q: "ช่วยปิดหน้าต่างให้หน่อยได้ไหมครับ (Te-moraimasenka)", a: "窓を閉めてもらえませんか。/窓を閉めてくださいませんか。" },
                    { q: "ถ้ากดปุ่มนี้ เงินทอนจะออกมา", a: "このボタンを押すと、お釣りが出ます。" },
                    { q: "คนที่ใส่แว่นตาอยู่คือคุณทานากะ", a: "眼鏡をかけている人は田中さんです。" },
                    { q: "นี่คือรูปถ่ายที่ถ่ายที่วัดทอง (Kinkakuji)", a: "これは金閣寺で撮った写真です。" },
                    { q: "พรุ่งนี้จะไปงานปาร์ตี้ไหม? (รูปธรรมดา) / อืม ไป", a: "明日、パーティーに行く? / うん、行く。" },
                    { q: "ถ้าไม่มีเวลา จะไม่ดูทีวี", a: "時間がなかったら、テレビを見ません。" },
                    { q: "ฉันให้คุณยามาดะบอกเบอร์โทรศัพท์ของหอสมุดให้", a: "山田さんに図書館の電話番号を教えてもらいました。" },
                    { q: "งานอดิเรกของฉันคือการอ่านหนังสือ", a: "私の趣味は本を読むことです。" },
                    { q: "ก่อนนอน จะแปรงฟัน", a: "寝る前に、歯を磨きます。" },
                    { q: "เคยปีนภูเขาไหม", a: "山に登ったことがありますか。" },
                    { q: "วันอาทิตย์ทําความสะอาดห้องบ้าง ซักผ้าบ้าง", a: "日曜日は部屋を掃除したり、洗濯したりします。" },
                    { q: "(ฉัน)เริ่มเก่งภาษาญี่ปุ่นแล้ว", a: "日本語が上手になりました。" },
                    { q: "อยากไปเที่ยวญี่ปุ่น (ใช้ tai)", a: "日本へ旅行したいです。/日本へ行きたいです。" },
                    { q: "ห้ามสูบบุหรี่ที่นี่", a: "ここでたばこを吸ってはいけません。" },
                    { q: "ต้องกินยา", a: "薬を飲まなければなりません。" }
                ]
            },
            part7: {
                title: "Part 7: ปรนัย (Multiple Choice)",
                instruction: "เลือกคำตอบที่ถูกต้อง",
                type: "multiple-choice",
                questions: [
                    { q: "「そんなに、きっと」彼は来ると思います。（เลือกคำวิเศษณ์ที่เหมาะสม）", options: ["きっと", "もし", "いくら"], a: 0 },
                    { q: "（　）雨が降ったら、行きません。", options: ["もし", "いくら", "たぶん"], a: 0 },
                    { q: "彼は（　）来ると思います。（มั่นใจมาก）", options: ["たぶん", "きっと", "もし"], a: 1 },
                    { q: "（　）高くても、買います。", options: ["もし", "たぶん", "いくら"], a: 2 },
                    { q: "（　）来ないと思います。（อาจจะ/ความเป็นไปได้）", options: ["もしかしたら", "きっと", "ぜひ"], a: 0 },
                    { q: "約束の時間に（　）、どうしますか。", options: ["間に合わなかったら", "間に合わないと", "間に合う"], a: 0 },
                    { q: "図書館で本を（　）とき、カードが要ります。", options: ["借りた", "借りる", "借りて"], a: 1 },
                    { q: "漢字を（　）ことができますか。", options: ["読む", "読み", "読んで"], a: 0 },
                    { q: "この料理は（　）食べますか。", options: ["どう", "どうやって", "どんな"], a: 1 },
                    { q: "約束がありますから、もう（　）。", options: ["帰ってもいいです", "帰らなければなりません", "帰ってはいけません"], a: 1 },
                    { q: "このボタンを（　）、お釣りが出ます。", options: ["押して", "押すと", "押した"], a: 1 },
                    { q: "A: 週末は（　）に行きたいですか。", options: ["何", "だれ", "どこ"], a: 2 },
                    { q: "これは（　）ケーキですか。", options: ["ミラーさんが作った", "ミラーさんを作った", "ミラーさんが作って"], a: 0 },
                    { q: "（　）とき、病院へ行きます。", options: ["病気な", "病気の", "病気"], a: 1 },
                    { q: "明日は（　）と思います。", options: ["寒いです", "寒い", "寒く"], a: 1 },
                    { q: "ここでたばこを（　）ください。", options: ["吸わないで", "吸いないで", "吸わなくて"], a: 0 },
                    { q: "私は（　）人に会いたいです。", options: ["親切", "親切な", "親切の"], a: 1 },
                    { q: "橋を（　）ます。", options: ["渡り", "渡れ", "渡っ"], a: 0 },
                    { q: "私は将来医者に（　）。", options: ["したいです", "なります", "なりました", "なりたいです"], a: 3 },
                    { q: "日本語が（　）なりました。", options: ["上手", "上手な", "上手に", "上手く"], a: 2 }
                ]
            }
        };

        const Icons = {
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        };

        const RubifiedText = ({ text, showFurigana }) => {
            if (!text) return null;
            const regex = /([\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3038-\u303B\u3400-\u4DB5\u4E00-\u9FCC\uF900-\uFA6D\uFA70-\uFAD9]+)\{([^\}]+)\}/g;
            const elements = [];
            let lastIndex = 0;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    elements.push(text.substring(lastIndex, match.index));
                }
                elements.push(
                    <ruby key={match.index}>
                        {match[1]}
                        <rt className={showFurigana ? '' : 'hidden'}>{match[2]}</rt>
                    </ruby>
                );
                lastIndex = regex.lastIndex;
            }
            if (lastIndex < text.length) elements.push(text.substring(lastIndex));
            return <>{elements}</>;
        };

        const MenuScreen = ({ onStart }) => (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-indigo-800 p-4">
                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full flex flex-col md:flex-row">
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors border-b md:border-b-0 md:border-r border-gray-200 flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 text-red-600 group-hover:scale-110 transition-transform"><Icons.Lock /></div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดสอบจริง</h2>
                        <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>จับเวลา 2 ชั่วโมง</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>ห้ามดูเฉลย</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>สุ่มข้อสอบตามแนวข้อสอบจริง</li>
                        </ul>
                        <button onClick={() => onStart('exam')} className="mt-auto px-8 py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg w-full transition-all hover:-translate-y-1">เริ่มสอบ</button>
                    </div>
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 group-hover:scale-110 transition-transform"><Icons.Unlock /></div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดฝึกฝน</h2>
                         <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ไม่มีเวลาจำกัด</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ดูเฉลยได้ทันที</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>คัดลอกโจทย์ได้</li>
                        </ul>
                        <div className="mt-auto w-full space-y-3">
                            <button onClick={() => onStart('practice_all')} className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold w-full transition-colors">ฝึกทำทุกข้อในคลัง</button>
                            <button onClick={() => onStart('practice_random')} className="px-8 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold w-full transition-colors">ฝึกแบบสุ่ม (เหมือนสอบ)</button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const InlineQuestionRenderer = ({ questionText, delimiter, questionId, userAnswers, onAnswer, showFurigana, fontSizeClass, isDisabled }) => {
            const parts = questionText.split(delimiter);
            
            return (
                <div className={`leading-loose ${fontSizeClass} text-gray-800 font-medium`}>
                    {parts.map((part, index) => (
                        <React.Fragment key={index}>
                            <RubifiedText text={part} showFurigana={showFurigana} />
                            {index < parts.length - 1 && (
                                <input
                                    type="text"
                                    disabled={isDisabled}
                                    value={userAnswers[`${questionId}-slot-${index}`] || ''}
                                    onChange={(e) => onAnswer(index, e.target.value)}
                                    className="inline-input"
                                    style={{ fontSize: '0.8em' }}
                                    autoComplete="off"
                                />
                            )}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        const ExamInterface = ({ mode, examData, onFinish, onHome }) => {
            const [activePart, setActivePart] = useState('part1');
            const [userAnswers, setUserAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(EXAM_CONFIG.duration);
            const [settings, setSettings] = useState({ fontSize: 1, showFurigana: true });
            const [showSettings, setShowSettings] = useState(false);
            const timerRef = useRef(null);

            const isExamMode = mode === 'exam';

            useEffect(() => {
                if (isExamMode) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timerRef.current);
                                onFinish(userAnswers, true);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [isExamMode, onFinish, userAnswers]);

            return (
                <div className={`min-h-screen pb-20 ${isExamMode ? 'no-select' : ''}`}>
                    <header className={`${isExamMode ? 'bg-red-900' : 'bg-indigo-700'} text-white p-3 sticky top-0 shadow-md transition-colors`}>
                        <div className="max-w-6xl mx-auto flex justify-between items-center relative">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={onHome}
                                    className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors text-white"
                                    title="หน้าหลัก"
                                >
                                    <Icons.Home />
                                </button>
                                <h1 className="font-bold text-lg flex items-center gap-2">
                                    {isExamMode ? <Icons.Lock /> : <Icons.Book />}
                                    <span className="hidden sm:inline font-medium">{isExamMode ? 'การสอบปลายภาค (จำลอง)' : 'โหมดฝึกฝน'}</span>
                                </h1>
                            </div>
                            
                            {isExamMode && (
                                <div className={`flex items-center gap-2 font-mono text-xl font-bold px-4 py-1 rounded-lg ${timeLeft < 300 ? 'bg-red-600 animate-pulse' : 'bg-black/30'}`}>
                                    <Icons.Clock /> {formatTime(timeLeft)}
                                </div>
                            )}

                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className="p-2 hover:bg-white/20 rounded-full transition-colors relative"
                                    title="ตั้งค่า"
                                >
                                    <Icons.Settings />
                                    {showSettings && (
                                        <div className="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 p-4 text-gray-800 animate-in fade-in slide-in-from-top-2 z-50 flex flex-col gap-4">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold">ขนาดตัวอักษร</span>
                                                <div className="flex bg-gray-100 rounded-lg p-1">
                                                    <button onClick={() => setSettings(s => ({...s, fontSize: Math.max(0, s.fontSize - 1)}))} className="w-8 h-8 hover:bg-white rounded font-bold">-</button>
                                                    <span className="w-8 h-8 flex items-center justify-center text-xs">{settings.fontSize + 1}</span>
                                                    <button onClick={() => setSettings(s => ({...s, fontSize: Math.min(2, s.fontSize + 1)}))} className="w-8 h-8 hover:bg-white rounded font-bold">+</button>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold">Furigana</span>
                                                <button 
                                                    onClick={() => setSettings(s => ({...s, showFurigana: !s.showFurigana}))}
                                                    className={`w-12 h-6 rounded-full relative transition-colors ${settings.showFurigana ? 'bg-indigo-500' : 'bg-gray-300'}`}
                                                >
                                                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${settings.showFurigana ? 'left-7' : 'left-1'}`}></div>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </button>
                                <button 
                                    onClick={() => {
                                        if(window.confirm('ต้องการส่งคำตอบและดูผลลัพธ์หรือไม่?')) onFinish(userAnswers, false);
                                    }}
                                    className="bg-white text-indigo-900 hover:bg-gray-100 px-5 py-2 rounded-lg text-sm font-bold shadow-sm"
                                >
                                    {isExamMode ? 'ส่งข้อสอบ' : 'สรุปผล'}
                                </button>
                            </div>
                        </div>

                        <div className="max-w-6xl mx-auto mt-3 overflow-x-auto flex gap-2 pb-1 scrollbar-hide">
                            {Object.keys(examData).map(key => (
                                <button
                                    key={key}
                                    onClick={() => { setActivePart(key); window.scrollTo({ top: 0 }); }}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${activePart === key ? 'bg-white text-indigo-900 shadow-md transform scale-105' : 'bg-black/20 hover:bg-black/30 text-white/90'}`}
                                >
                                    {key.replace('part', 'Part ')}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2 border-b pb-4 border-gray-100">{examData[activePart].title}</h2>
                            <p className="text-gray-500 mb-8 bg-gray-50 p-3 rounded-lg border-l-4 border-indigo-400">{examData[activePart].instruction}</p>

                            <div className="space-y-8">
                                {examData[activePart].questions.map((qData, idx) => (
                                    <div key={`${activePart}-${idx}`} className={`relative group ${settings.showFurigana ? '' : 'hide-furigana'}`}>
                                        <div className="absolute -left-3 md:-left-8 top-1 font-bold text-gray-300 text-xl">{idx + 1}</div>
                                        
                                        {/* Question Render Logic */}
                                        <div className="mb-4">
                                            {examData[activePart].type === 'fill-in-inline' ? (
                                                <InlineQuestionRenderer 
                                                    questionText={qData.q}
                                                    delimiter={examData[activePart].delimiter}
                                                    questionId={`${activePart}-${idx}`}
                                                    userAnswers={userAnswers}
                                                    onAnswer={(slot, val) => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}-slot-${slot}`]: val}))}
                                                    showFurigana={settings.showFurigana}
                                                    fontSizeClass={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}
                                                    isDisabled={false}
                                                />
                                            ) : (
                                                <p className={`${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]} font-medium text-gray-800 jp-text leading-loose`}>
                                                    <RubifiedText text={qData.q} showFurigana={settings.showFurigana} />
                                                </p>
                                            )}
                                        </div>

                                        {/* Answer Input (for non-inline types) */}
                                        {examData[activePart].type === 'multiple-choice' && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {qData.options.map((opt, optIdx) => (
                                                    <button
                                                        key={optIdx}
                                                        onClick={() => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}`]: optIdx}))}
                                                        className={`p-3 text-left rounded-lg border-2 transition-all ${userAnswers[`${activePart}-${idx}`] === optIdx ? 'border-indigo-500 bg-indigo-50 text-indigo-900 font-medium shadow-sm' : 'border-gray-200 hover:border-gray-300 bg-white'}`}
                                                    >
                                                        <span className="mr-2 text-gray-400 font-bold">{String.fromCharCode(97 + optIdx)}.</span>
                                                        <span className={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}>
                                                            <RubifiedText text={opt} showFurigana={settings.showFurigana} />
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {examData[activePart].type === 'fill-in' && (
                                            <textarea
                                                value={userAnswers[`${activePart}-${idx}`] || ''}
                                                onChange={(e) => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}`]: e.target.value}))}
                                                placeholder="พิมพ์คำตอบ..."
                                                rows="2"
                                                className={`w-full p-3 rounded-lg border-2 border-gray-200 focus:border-indigo-500 outline-none transition-colors bg-gray-50 focus:bg-white ${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]} jp-text`}
                                            />
                                        )}

                                        {/* Instant Answer (Practice Mode) */}
                                        {!isExamMode && (
                                            <PracticeAnswerReveal qData={qData} type={examData[activePart].type} settings={settings} />
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-between">
                             <button onClick={() => { const keys = Object.keys(examData); const prev = keys[keys.indexOf(activePart) - 1]; if(prev) { setActivePart(prev); window.scrollTo({top:0}); }}} disabled={activePart === 'part1'} className="px-6 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold disabled:opacity-50">&larr; ก่อนหน้า</button>
                             <button onClick={() => { const keys = Object.keys(examData); const next = keys[keys.indexOf(activePart) + 1]; if(next) { setActivePart(next); window.scrollTo({top:0}); }}} disabled={activePart === 'part7'} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 disabled:opacity-50">ถัดไป &rarr;</button>
                        </div>
                    </main>
                </div>
            );
        };

        const PracticeAnswerReveal = ({ qData, type, settings }) => {
            const [revealed, setRevealed] = useState(false);
            return (
                <div className="mt-3">
                    <button onClick={() => setRevealed(!revealed)} className="text-sm text-indigo-500 hover:text-indigo-700 font-medium flex items-center gap-1"><Icons.Eye /> {revealed ? 'ซ่อนเฉลย' : 'ดูเฉลย'}</button>
                    {revealed && (
                        <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg text-green-800 animate-in fade-in slide-in-from-top-1">
                            <span className="font-bold text-xs uppercase tracking-wide text-green-600 block mb-1">เฉลย:</span>
                            {type === 'multiple-choice' ? (
                                <span>ข้อ {String.fromCharCode(97 + qData.a)}: <strong>{qData.options[qData.a]}</strong></span>
                            ) : (
                                <span className={`jp-text font-medium ${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}`}>{qData.a}</span>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const ResultSummary = ({ examData, userAnswers, onRestart }) => {
            const [settings, setSettings] = useState({ fontSize: 1, showFurigana: true });
            
            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8 text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">จบการทดสอบ / สรุปผล</h2>
                            <p className="text-gray-600 mb-6">กรุณาตรวจสอบคำตอบด้วยตนเองจากเฉลยด้านล่าง</p>
                            <button onClick={onRestart} className="px-8 py-3 bg-gray-800 hover:bg-black text-white rounded-lg font-bold shadow-lg transition-transform hover:-translate-y-1">กลับไปหน้าเมนูหลัก</button>
                        </div>

                        <div className="space-y-8">
                            {Object.entries(examData).map(([partKey, partData]) => (
                                <div key={partKey} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-100 px-6 py-4 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                                        <span>{partData.title}</span>
                                        <span className="text-xs bg-gray-200 px-2 py-1 rounded text-gray-500">{partData.questions.length} ข้อ</span>
                                    </div>
                                    <div className="p-6 space-y-6">
                                        {partData.questions.map((q, idx) => {
                                            const isMc = partData.type === 'multiple-choice';
                                            const uAns = userAnswers[`${partKey}-${idx}`];
                                            
                                            return (
                                                <div key={idx} className={`border-l-4 pl-4 ${isMc ? (uAns === q.a ? 'border-green-400' : 'border-red-400') : 'border-blue-300'} ${settings.showFurigana ? '' : 'hide-furigana'}`}>
                                                    <div className="mb-2">
                                                        {partData.type === 'fill-in-inline' ? (
                                                            <InlineQuestionRenderer 
                                                                questionText={q.q}
                                                                delimiter={partData.delimiter}
                                                                questionId={`${partKey}-${idx}`}
                                                                userAnswers={userAnswers}
                                                                onAnswer={() => {}} // Read-only
                                                                showFurigana={settings.showFurigana}
                                                                fontSizeClass={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}
                                                                isDisabled={true}
                                                            />
                                                        ) : (
                                                            <p className="font-medium text-gray-800 jp-text"><RubifiedText text={q.q} showFurigana={true} /></p>
                                                        )}
                                                    </div>
                                                    
                                                    {isMc ? (
                                                        <div className="text-sm mb-1">
                                                            <span className="text-gray-500">ตอบ: </span>
                                                            <span className={`font-medium ${uAns === q.a ? 'text-green-600' : 'text-red-600'}`}>
                                                                {uAns !== undefined ? <RubifiedText text={q.options[uAns]} showFurigana={true} /> : '-'}
                                                            </span>
                                                        </div>
                                                    ) : partData.type === 'fill-in' && (
                                                        <div className="text-sm mb-1 text-gray-600">
                                                            <span>ตอบ: {uAns || '-'}</span>
                                                        </div>
                                                    )}

                                                    <div className="text-sm bg-green-50 p-2 rounded text-green-800 inline-block mt-1">
                                                        <span className="font-bold">เฉลย: </span>
                                                        {isMc ? <RubifiedText text={q.options[q.a]} showFurigana={true} /> : q.a}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        };

        const App = () => {
            const [gameState, setGameState] = useState('menu');
            const [mode, setMode] = useState(null);
            const [currentExamData, setCurrentExamData] = useState(null);
            const [finalAnswers, setFinalAnswers] = useState({});

            const startExam = (selectedMode) => {
                let data = {};
                try {
                    if (selectedMode === 'practice_all') {
                        data = QUESTION_POOL;
                    } else {
                        // Randomize for Exam or Random Practice
                        Object.keys(QUESTION_POOL).forEach(key => {
                            const pool = QUESTION_POOL[key];
                            const count = EXAM_CONFIG.counts[key] || 5;
                            // Ensure we don't request more than available
                            const safeCount = Math.min(count, pool.questions.length);
                            data[key] = {
                                ...pool,
                                questions: getRandomQuestions(pool.questions, safeCount)
                            };
                        });
                    }
                    setCurrentExamData(data);
                    setMode(selectedMode);
                    setGameState('exam');
                    window.scrollTo(0, 0);
                } catch (error) {
                    console.error("Error starting exam:", error);
                    alert("เกิดข้อผิดพลาดในการเริ่มข้อสอบ กรุณาลองใหม่อีกครั้ง");
                }
            };

            const finishExam = (answers, isTimeOut) => {
                setFinalAnswers(answers);
                setGameState('result');
                if (isTimeOut) alert("หมดเวลาการสอบ!");
                window.scrollTo(0, 0);
            };

            if (gameState === 'menu') return <MenuScreen onStart={startExam} />;
            if (gameState === 'exam') return <ExamInterface mode={mode} examData={currentExamData} onFinish={finishExam} onHome={() => setGameState('menu')} />;
            if (gameState === 'result') return <ResultSummary examData={currentExamData} userAnswers={finalAnswers} onRestart={() => setGameState('menu')} />;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
