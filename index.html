<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPN1102 Exam Simulator (Complete Edition)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .jp-text { font-family: 'Noto Sans JP', sans-serif; line-height: 2.5; }
        
        /* Ruby Styling */
        ruby { font-family: 'Noto Sans JP', sans-serif; ruby-align: center; }
        rt { font-size: 0.6em; color: #6b7280; font-weight: normal; user-select: none; }
        .hide-furigana rt { display: none; }
        .hide-furigana ruby { ruby-position: unset; }

        .no-select { user-select: none; }
        
        /* Inline Input Styling */
        .inline-input {
            display: inline-block;
            border-bottom: 2px solid #6366f1;
            background: #f9fafb;
            text-align: center;
            padding: 0 0.25rem;
            margin: 0 0.25rem;
            border-radius: 0.25rem 0.25rem 0 0;
            outline: none;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', sans-serif;
            min-width: 80px;
            color: #4338ca;
            font-weight: bold;
        }
        .inline-input:focus {
            background: #e0e7ff;
            border-color: #4338ca;
        }
        /* Sticky Header Fix */
        header { z-index: 50; }
        
        /* Hide Scrollbar for Nav */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- CONFIGURATION ---
        // กำหนดจำนวนข้อที่จะสุ่มมาสอบในแต่ละ Part
        const EXAM_CONFIG = {
            duration: 120 * 60, // 2 ชั่วโมง
            counts: {
                part1: 15, // คำช่วย (Joshi)
                part2: 5,  // ผันรูป
                part3: 7,  // ถาม-ตอบ
                part4: 5,  // แยกประโยค
                part5: 10, // แก้ประโยค
                part6: 10, // แปล
                part7: 10  // ปรนัย
            }
        };

        // --- QUESTION POOL (คลังข้อสอบขนาดใหญ่) ---
        const QUESTION_POOL = {
            part1: {
                title: "Part 1: เติมคำช่วย (Joshi)",
                instruction: "จงเติมคำช่วยที่ถูกต้องลงในช่องว่างในประโยค",
                type: "fill-in-inline", 
                delimiter: /（　）/,   
                questions: [
                    // ชุดที่ 1 (เดิม)
                    { q: "あれ（　）佐藤{さとう}さん（　）くれたワインです。", a: "あれ（は）佐藤さん（が）くれたワインです。" },
                    { q: "時間{じかん}（　）あったら、京都{きょうと}（　）旅行{りょこう}したいです。", a: "時間（が）あったら、京都（へ/に）旅行したいです。" },
                    { q: "父{ちち}は私{わたし}（　）時計{とけい}（　）買{か}ってくれました。", a: "父は私（に）時計（を）買ってくれました。" },
                    { q: "私{わたし}（　）家族{かぞく}（　）日本{にほん}へ行{い}きたいです。", a: "私（は）家族（と）日本へ行きたいです。" },
                    { q: "ここ（　）タバコ（　）吸{す}ってはいけません。", a: "ここ（で）タバコ（を）吸ってはいけません。" },
                    // ชุดที่ 2 (เพิ่มเติมจาก PDF)
                    { q: "先生{せんせい}（　）聞{き}きました（　）、テストは明日{あした}だそうです。", a: "先生（に）聞きました（が）、テストは明日だそうです。" },
                    { q: "京都駅{きょうとえき}（　）電車{でんしゃ}（　）乗{の}ります。", a: "京都駅（で）電車（に）乗ります。" },
                    { q: "電車{でんしゃ}（　）降{お}りて、バス（　）乗{の}り換{か}えます。", a: "電車（を）降りて、バス（に）乗り換えます。" },
                    { q: "友達{ともだち}（　）約束{やくそく}（　）ありますから、帰{かえ}ります。", a: "友達（と）約束（が）ありますから、帰ります。" },
                    { q: "この図{ず}（　）とおりに、折{お}って（　）ください。", a: "この図（の）とおりに、折って（ください）。" },
                    { q: "砂糖{さとう}（　）入{い}れない（　）、おいしくないです。", a: "砂糖（を）入れない（と）、おいしくないです。" },
                    { q: "雨{あめ}（　）降{ふ}っても、洗濯{せんたく}（　）します。", a: "雨（が）降っても、洗濯（を）します。" },
                    { q: "部長{ぶちょう}（　）資料{しりょう}（　）送{おく}っておきました。", a: "部長（に）資料（を）送っておきました。" },
                    { q: "壁{かべ}（　）カレンダー（　）掛{か}けてあります。", a: "壁（に）カレンダー（が）掛けてあります。" },
                    { q: "遅刻{ちこく}した理由{りゆう}（　）先生{せんせい}（　）説明{せつめい}しました。", a: "遅刻した理由（を）先生（に）説明しました。" },
                    // ชุดที่ 3 (เพิ่มเติมจากคลังข้อสอบจำลอง)
                    { q: "あれ（　）友達{ともだち}（　）撮{と}った写真{しゃしん}です。", a: "あれ（は）友達（が）撮った写真です。" },
                    { q: "元気{げんき}（　）とき、毎日{まいにち}、お酒（　）ワインを飲まない（　） 思{おも}います。", a: "元気（な）とき、毎日、お酒（や）ワインを飲まない（と） 思います。" },
                    { q: "京都{きょうと}へ行{い}く人{ひと}（　）ミラーさんです。", a: "京都へ行く人（は）ミラーさんです。" },
                    { q: "これはミラーさんが住{す}んでいたうち（　）近{ちか}いです。", a: "これはミラーさんが住んでいたうち（に）近いです。" },
                    { q: "私{わたし}は彼{かれ}（　）パソコン（　）教{おし}えてもらいました。", a: "私は彼（に）パソコン（を）教えてもらいました。" },
                    { q: "部長{ぶちょう}（　）資料{しりょう}（　）送{おく}っていただきました。", a: "部長（に）資料（を）送っていただきました。" },
                    { q: "お金{かね}（　）あったら、旅行{りょこう}（　）します。", a: "お金（が）あったら、旅行（を）します。" },
                    { q: "明日{あした}、会議{かいぎ}（　）意見{いけん}（　）言{い}うつもりです。", a: "明日、会議（で）意見（を）言うつもりです。" },
                    { q: "右{みぎ}（　）曲{ま}がる（　）、郵便局{ゆうびんきょく}があります。", a: "右（へ）曲がる（と）、郵便局があります。" },
                    { q: "図書館{としょかん}（　）本{ほん}（　）借{か}りるとき、カードが要{い}ります。", a: "図書館（で）本（を）借りるとき、カードが要ります。" },
                    { q: "公園{こうえん}（　）散歩{さんぽ}します。", a: "公園（を）散歩します。" },
                    { q: "道{みち}（　）渡{わた}ります。", a: "道（を）渡ります。" },
                    { q: "交差点{こうさてん}（　）右{みぎ}へ曲{ま}がります。", a: "交差点（を）右へ曲がります。" },
                    { q: "坂{さか}（　）上{のぼ}ります。", a: "坂（を）上ります。" },
                    { q: "この橋{はし}（　）渡{わた}ってはいけません。", a: "この橋（を）渡ってはいけません。" }
                ]
            },
            part2: {
                title: "Part 2: ผันรูปคำกริยา/คำศัพท์",
                instruction: "เปลี่ยนคำในวงเล็บให้อยู่ในรูปที่ถูกต้อง",
                type: "fill-in-inline",
                delimiter: /_______/, 
                questions: [
                    { q: "（行{い}きます → _______ ）とき、「行{い}ってまいります」と言{い}います。", a: "出かける (Dict form) / 行く" },
                    { q: "あそこで（歌{うた}っています → _______ ）人{ひと}は誰{だれ}ですか。", a: "歌っている" },
                    { q: "これは母{はは}が（作{つく}りました → _______ ）ケーキです。", a: "作った" },
                    { q: "もっと（勉強{べんきょう}します → _______ ）ほうがいいですよ。", a: "勉強した" },
                    { q: "明日{あした}は（雪{ゆき}です → _______ ）かもしれません。", a: "雪" },
                    { q: "この本{ほん}は（読{よ}みます → _______ ）やすいです。", a: "読み" },
                    { q: "（暑{あつ}いです → _______ ）し、喉{のど}も乾{かわ}きました。", a: "暑い" },
                    { q: "窓{まど}が（割{わ}ります → _______ ）います。", a: "割れて" },
                    { q: "（飲{の}みます → _______ ）すぎました。", a: "飲み" },
                    { q: "（聞{き}きます → _______ ）とおりに、書{か}いてください。", a: "聞いた" },
                    // New from PDFs
                    { q: "おいしいですから、（食{た}べます → _______ ）。", a: "食べてください" },
                    { q: "これはミラーさんが（作{つく}ります → _______ ）料理{りょうり}です。", a: "作った" },
                    { q: "もし 1億円（あります → _______ ）、世界旅行をしたいです。", a: "あったら" },
                    { q: "約束の時間に友達が（来ません → _______ ）、どうしますか。", a: "来なかったら" },
                    { q: "いくら（安いです → _______ ）、グループ旅行は嫌いです。", a: "安くても" },
                    { q: "（使{つか}います → _______ ）方{かた}が分{わ}かりません。", a: "使い" },
                    { q: "（眠{ねむ}いです → _______ ）ら、寝{ね}てもいいですよ。", a: "眠かった" },
                    { q: "エアコンを（つけます → _______ ）と、涼{すず}しくなります。", a: "つける" }
                ]
            },
            part3: {
                title: "Part 3: ตอบคำถาม (Q&A)",
                instruction: "ตอบคำถามให้สมบูรณ์ (หรือคิดคำตอบในใจแล้วตรวจทาน)",
                type: "fill-in",
                questions: [
                    { q: "誰{だれ}に日本語{にほんご}を教{おし}えてもらいましたか。", a: "日本人の先生に教えてもらいました。" },
                    { q: "財布{さいふ}を落{お}としたとき、どうしますか。", a: "交番へ行きます。" },
                    { q: "日本{にほん}へ行{い}ったことがありますか。", a: "はい、行ったことがあります。 / いいえ、行ったことがありません。" },
                    { q: "日曜日{にちようび}は何{なに}をしたり、何{なに}をしたりしますか。", a: "テニスをしたり、映画を見たりします。" },
                    { q: "将来{しょうらい}、何{なん}になりたいですか。", a: "医者になりたいです。" },
                    { q: "今{いま}の首相{しゅしょう}についてどう思{おも}いますか。", a: "いい人だと思います。 / よく働くと思います。" },
                    { q: "会議{かいぎ}の前{まえ}に、何{なに}をしておかなければなりませんか。", a: "資料をコピーしておかなければなりません。" },
                    { q: "どうして昨日{きのう}学校{がっこう}を休{やす}みましたか。", a: "熱があったんです。" },
                    { q: "もう昼{ひる}ご飯{はん}を食{た}べましたか。", a: "いいえ、まだ食べていません。" },
                    { q: "週末{しゅうまつ}、天気{てんき}がよかったら、どこへ行{い}きたいですか。", a: "海へ行きたいです。" },
                    // New from PDFs
                    { q: "どんなとき、お皿{さら}を洗{あら}わなければなりませんか。", a: "ご飯を食べたとき、お皿を洗わなければなりません。" },
                    { q: "紅茶{こうちゃ}に砂糖{さとう}を入{い}れないと どうなりますか。", a: "おいしくなくなります。" },
                    { q: "今{いま}、彼{かれ}が食{た}べる料理{りょうり}はどれですか。", a: "あなたが作る料理です。" },
                    { q: "明日{あした}、暇{ひま}だったら、何{なに}をしますか。", a: "映画を見に行きます。" }
                ]
            },
            part4: {
                title: "Part 4: แยกประโยค",
                instruction: "ระบุประโยคหลัก (Main) และส่วนขยาย (Sub/Modifier)",
                type: "fill-in",
                questions: [
                    { q: "私{わたし}は 朝{あさ}ご飯{はん}を食{た}べる 時間{じかん}がありません。", a: "Main: 私は時間がありません。 / Sub: 朝ごはんを食べる。" },
                    { q: "京都{きょうと}へ行{い}く人{ひと}は ミラーさんです。", a: "Main: 人はミラーさんです。 / Sub: 京都へ行く。" },
                    { q: "私{わたし}が住{す}んでいるアパートは便利{べんり}です。", a: "Main: アパートは便利です。 / Sub: 私が住んでいる。" },
                    { q: "父{ちち}が生{う}まれた所{ところ}は北海道{ほっかいどう}です。", a: "Main: 所は北海道です。 / Sub: 父が生まれた。" },
                    { q: "昨日{きのう}習{なら}った言葉{ことば}を忘{わす}れました。", a: "Main: 言葉を忘れました。 / Sub: 昨日習った。" },
                    { q: "彼{かれ}が来{こ}ない理由{りゆう}を知{し}っていますか。", a: "Main: 理由を知っていますか。 / Sub: 彼が来ない。" },
                    { q: "母{はは}が作{つく}った料理{りょうり}はおいしいです。", a: "Main: 料理はおいしいです。 / Sub: 母が作った。" },
                    { q: "帽子{ぼうし}をかぶっている人{ひと}は田中{たなか}さんです。", a: "Main: 人は田中さんです。 / Sub: 帽子をかぶっている。" },
                    // New from PDFs
                    { q: "これはシャオ先生{せんせい}が書{か}いた絵{え}です。", a: "Main: これは絵です。 / Sub: シャオ先生が書いた。" },
                    { q: "今日{きょう}、本{ほん}を返{かえ}します。", a: "Main: 本を返します。 / Sub: なし" },
                    { q: "妻{つま}が病気{びょうき}のとき、会社{かいしゃ}を休{やす}みます。", a: "Main: 会社を休みます。 / Sub: 妻が病気の(とき)。" },
                    { q: "友達{ともだち}が約束{やくそく}の時間{じかん}に来{こ}なかったら、どうしますか。", a: "Main: どうしますか。 / Sub: 友達が約束の時間に来なかったら。" }
                ]
            },
            part5: {
                title: "Part 5: แก้ไขประโยค (Error Correction)",
                instruction: "แก้ไขประโยคที่ผิดไวยากรณ์ให้ถูกต้อง",
                type: "fill-in",
                questions: [
                    { q: "雨{あめ}が降{ふ}ると、出{で}かけません。", a: "雨が降ったら、出かけません。" },
                    { q: "安{やす}いで、おいしいです。", a: "安くて、おいしいです。" },
                    { q: "私{わたし}は花{はな}に水{みず}をくれました。", a: "あげました / やりました" },
                    { q: "日本{にほん}へ行{い}ったことがありません。", a: "日本へ行ったことがありません。（Correct） / 行った → 行く (Error if context implies never)" },
                    { q: "明日{あした}、雨{あめ}が降{ふ}らないと思{おも}います。", a: "明日、雨が降らないと思います。（Correct）" },
                    { q: "頭{あたま}が痛{いた}い、帰{かえ}ってもいいですか。", a: "頭が痛いので／痛いですから、帰ってもいいですか。" },
                    { q: "この本{ほん}は読{よ}みやすいです。", a: "この本は読みやすいです。（Correct）" },
                    { q: "窓{まど}を開{あ}けています。", a: "窓が開いています。（State） / 窓を開けてあります。" },
                    { q: "財布{さいふ}を落{お}としてしまいました。", a: "財布を落としてしまいました。（Correct）" },
                    { q: "試験{しけん}に合格{ごうかく}するように、勉強{べんきょう}しています。", a: "試験に合格するように、勉強しています。（Correct）" },
                    // New
                    { q: "彼{かれ}は本{ほん}をもらいました。山田{やまだ}さんが送{おく}ってあげましたか。", a: "山田さんが送ってくれましたか。" },
                    { q: "サントスさんは誰{だれ}にペンを貸{か}してあげましたか。", a: "ถูกต้องแล้ว (Correct)" },
                    { q: "部屋{へや}はきれいだったら、借{か}りたいです。", a: "部屋がきれいだったら" },
                    { q: "元気{げんき}でも、薬{くすり}を飲{の}まなければなりません。", a: "元気だったら、薬を飲まなくてもいいです。" }
                ]
            },
            part6: {
                title: "Part 6: การแปล (Translation)",
                instruction: "แปลประโยคต่อไปนี้เป็นภาษาญี่ปุ่น/ไทย",
                type: "fill-in",
                questions: [
                    { q: "พรุ่งนี้ ถ้าฝนตก จะไม่ออกไปข้างนอก", a: "明日、雨が降ったら、出かけません。" },
                    { q: "คุณมิลเลอร์พูดว่า \"พรุ่งนี้จะไปโตเกียว\"", a: "ミラーさんは「明日、東京へ行きます」と言いました。" },
                    { q: "กรุณาอย่าลืมร่ม", a: "傘を忘れないでください。" },
                    { q: "เคยปีนภูเขาไฟฟูจิไหม", a: "富士山に登ったことがありますか。" },
                    { q: "ช่วงนี้ยุ่ง ก็เลยไม่ได้ไปไหนเลย", a: "最近忙しいので／忙しいから、どこも行きませんでした。" },
                    { q: "ฉันให้ดอกไม้แฟน (ผู้หญิง)", a: "私は彼女に花をあげました。" },
                    { q: "ได้รับช็อกโกแลตจากใคร", a: "誰に／から チョコレートをもらいましたか。" },
                    { q: "ก่อนนอน แปรงฟัน", a: "寝る前に、歯を磨きます。" },
                    { q: "หลังจากกินข้าว จะดื่มกาแฟ", a: "ご飯を食べた後で、コーヒーを飲みます。" },
                    { q: "ช่วยปิดประตูหน่อยได้ไหม", a: "ドアを閉めてくれませんか／いただけませんか。" },
                    { q: "ถ้ากดปุ่มนี้ เงินทอนจะออกมา", a: "このボタンを押すと、お釣りが出ます。" },
                    { q: "ดูเหมือนฝนจะตก", a: "雨が降りそうです。" },
                    { q: "ได้ยินว่าพรุ่งนี้อากาศจะเย็น", a: "明日は涼しくなるそうです。" },
                    // New from PDFs
                    { q: "เวลาภรรยาไม่สบาย (ฉัน) จะลางาน", a: "妻が病気のとき、会社を休みます。" },
                    { q: "ถึงแม้เพื่อนไม่มาช่วย ก็จะทำอาหารด้วยตัวเอง", a: "友達が手伝ってくれなくても、自分で料理を作ります。" },
                    { q: "ถ้าเพื่อนชวน จะทำอย่างไร", a: "友達が誘ったら、どうしますか。" },
                    { q: "ฉันได้รับนาฬิกาเรือนนี้มาจากพี่สาว", a: "（私は）姉にこの時計をもらいました。" },
                    { q: "ฉันซื้อจักรยานให้ลูกชาย", a: "（私は）息子に自転車を買ってあげました。" },
                    { q: "คุณแม่ส่งพัสดุมาให้ฉัน", a: "母は（私に）荷物を送ってくれました。" },
                    { q: "คิดว่าราคาของที่ญี่ปุ่นแพง", a: "日本の物価は高いと思います。" }
                ]
            },
            part7: {
                title: "Part 7: ปรนัย (Multiple Choice)",
                instruction: "เลือกข้อที่ถูกต้องที่สุด",
                type: "multiple-choice",
                questions: [
                    { q: "（　）雨{あめ}が降{ふ}ったら、行{い}きません。", options: ["もし", "いくら", "たぶん", "ぜひ"], a: 0 },
                    { q: "彼{かれ}は（　）来{く}ると思{おも}います。", options: ["たぶん", "きっと", "もし", "いくら"], a: 1 },
                    { q: "（　）高{たか}くても、買{か}います。", options: ["もし", "たぶん", "いくら", "ぜひ"], a: 2 },
                    { q: "（　）来{こ}ないと思{おも}います。", options: ["もしかしたら", "きっと", "ぜひ", "いろいろ"], a: 0 },
                    { q: "道{みち}が（　）なりました。", options: ["複雑", "複雑に", "複雑な", "複雑く"], a: 1 },
                    { q: "（　）お祈{いの}りしましたか。", options: ["一度", "一度も", "一回も", "いつ"], a: 1 },
                    { q: "お湯{ゆ}が（　）。", options: ["出します", "出ます", "おります", "おろします"], a: 1 },
                    { q: "音{おと}を（　）します。", options: ["大きい", "大きく", "大きに", "大きくて"], a: 1 },
                    { q: "（　）遊{あそ}びに来{き}てください。", options: ["きっと", "ぜひ", "たぶん", "もし"], a: 1 },
                    { q: "約束{やくそく}の時間{じかん}に（　）、どうしますか。", options: ["間に合わなかったら", "間に合わないと", "間に合わなくて", "間に合う"], a: 0 },
                    { q: "図書館{としょかん}で本{ほん}を（　）とき、カードが要{い}ります。", options: ["借りた", "借りる", "借りて", "借ります"], a: 1 },
                    { q: "砂糖{さとう}を（　）なくてもいいですよ。", options: ["入れ", "入ら", "入る", "入って"], a: 0 },
                    { q: "窓{まど}が（　）います。", options: ["閉めて", "閉まって", "閉め", "閉まり"], a: 1 },
                    { q: "電車{でんしゃ}に（　）忘{わす}れました。", options: ["傘を", "傘が", "傘で", "傘に"], a: 0 },
                    { q: "壁{かべ}に絵{え}が（　）あります。", options: ["かけ", "かけて", "かかって", "かかり"], a: 1 }
                ]
            }
        };

        const Icons = {
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        };

        const RubifiedText = ({ text, showFurigana }) => {
            if (!text) return null;
            const regex = /([\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3038-\u303B\u3400-\u4DB5\u4E00-\u9FCC\uF900-\uFA6D\uFA70-\uFAD9]+)\{([^\}]+)\}/g;
            const elements = [];
            let lastIndex = 0;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    elements.push(text.substring(lastIndex, match.index));
                }
                elements.push(
                    <ruby key={match.index}>
                        {match[1]}
                        <rt className={showFurigana ? '' : 'hidden'}>{match[2]}</rt>
                    </ruby>
                );
                lastIndex = regex.lastIndex;
            }
            if (lastIndex < text.length) elements.push(text.substring(lastIndex));
            return <>{elements}</>;
        };

        const MenuScreen = ({ onStart }) => (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-indigo-800 p-4">
                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full flex flex-col md:flex-row">
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors border-b md:border-b-0 md:border-r border-gray-200 flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 text-red-600 group-hover:scale-110 transition-transform"><Icons.Lock /></div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดสอบจริง</h2>
                        <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>จับเวลา 2 ชั่วโมง</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>ห้ามดูเฉลย</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>สุ่มข้อสอบตามแนวข้อสอบจริง</li>
                        </ul>
                        <button onClick={() => onStart('exam')} className="mt-auto px-8 py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg w-full transition-all hover:-translate-y-1">เริ่มสอบ</button>
                    </div>
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 group-hover:scale-110 transition-transform"><Icons.Unlock /></div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดฝึกฝน</h2>
                         <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ไม่มีเวลาจำกัด</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ดูเฉลยได้ทันที</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>คัดลอกโจทย์ได้</li>
                        </ul>
                        <div className="mt-auto w-full space-y-3">
                            <button onClick={() => onStart('practice_all')} className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold w-full transition-colors">ฝึกทำทุกข้อในคลัง</button>
                            <button onClick={() => onStart('practice_random')} className="px-8 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold w-full transition-colors">ฝึกแบบสุ่ม (เหมือนสอบ)</button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const InlineQuestionRenderer = ({ questionText, delimiter, questionId, userAnswers, onAnswer, showFurigana, fontSizeClass, isDisabled }) => {
            const parts = questionText.split(delimiter);
            
            return (
                <div className={`leading-loose ${fontSizeClass} text-gray-800 font-medium`}>
                    {parts.map((part, index) => (
                        <React.Fragment key={index}>
                            <RubifiedText text={part} showFurigana={showFurigana} />
                            {index < parts.length - 1 && (
                                <input
                                    type="text"
                                    disabled={isDisabled}
                                    value={userAnswers[`${questionId}-slot-${index}`] || ''}
                                    onChange={(e) => onAnswer(index, e.target.value)}
                                    className="inline-input"
                                    style={{ fontSize: '0.8em' }}
                                    autoComplete="off"
                                />
                            )}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        const ExamInterface = ({ mode, examData, onFinish, onHome }) => {
            const [activePart, setActivePart] = useState('part1');
            const [userAnswers, setUserAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(EXAM_CONFIG.duration);
            const [settings, setSettings] = useState({ fontSize: 1, showFurigana: true });
            const [showSettings, setShowSettings] = useState(false);
            const timerRef = useRef(null);

            const isExamMode = mode === 'exam';

            useEffect(() => {
                if (isExamMode) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timerRef.current);
                                onFinish(userAnswers, true);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [isExamMode, onFinish, userAnswers]);

            return (
                <div className={`min-h-screen pb-20 ${isExamMode ? 'no-select' : ''}`}>
                    <header className={`${isExamMode ? 'bg-red-900' : 'bg-indigo-700'} text-white p-3 sticky top-0 shadow-md transition-colors`}>
                        <div className="max-w-6xl mx-auto flex justify-between items-center relative">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={onHome}
                                    className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition-colors text-white"
                                    title="หน้าหลัก"
                                >
                                    <Icons.Home />
                                </button>
                                <h1 className="font-bold text-lg flex items-center gap-2">
                                    {isExamMode ? <Icons.Lock /> : <Icons.Book />}
                                    <span className="hidden sm:inline font-medium">{isExamMode ? 'การสอบปลายภาค (จำลอง)' : 'โหมดฝึกฝน'}</span>
                                </h1>
                            </div>
                            
                            {isExamMode && (
                                <div className={`flex items-center gap-2 font-mono text-xl font-bold px-4 py-1 rounded-lg ${timeLeft < 300 ? 'bg-red-600 animate-pulse' : 'bg-black/30'}`}>
                                    <Icons.Clock /> {formatTime(timeLeft)}
                                </div>
                            )}

                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setShowSettings(!showSettings)}
                                    className="p-2 hover:bg-white/20 rounded-full transition-colors relative"
                                    title="ตั้งค่า"
                                >
                                    <Icons.Settings />
                                    {showSettings && (
                                        <div className="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 p-4 text-gray-800 animate-in fade-in slide-in-from-top-2 z-50 flex flex-col gap-4">
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold">ขนาดตัวอักษร</span>
                                                <div className="flex bg-gray-100 rounded-lg p-1">
                                                    <button onClick={() => setSettings(s => ({...s, fontSize: Math.max(0, s.fontSize - 1)}))} className="w-8 h-8 hover:bg-white rounded font-bold">-</button>
                                                    <span className="w-8 h-8 flex items-center justify-center text-xs">{settings.fontSize + 1}</span>
                                                    <button onClick={() => setSettings(s => ({...s, fontSize: Math.min(2, s.fontSize + 1)}))} className="w-8 h-8 hover:bg-white rounded font-bold">+</button>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-sm font-bold">Furigana</span>
                                                <button 
                                                    onClick={() => setSettings(s => ({...s, showFurigana: !s.showFurigana}))}
                                                    className={`w-12 h-6 rounded-full relative transition-colors ${settings.showFurigana ? 'bg-indigo-500' : 'bg-gray-300'}`}
                                                >
                                                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${settings.showFurigana ? 'left-7' : 'left-1'}`}></div>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </button>
                                <button 
                                    onClick={() => {
                                        if(window.confirm('ต้องการส่งคำตอบและดูผลลัพธ์หรือไม่?')) onFinish(userAnswers, false);
                                    }}
                                    className="bg-white text-indigo-900 hover:bg-gray-100 px-5 py-2 rounded-lg text-sm font-bold shadow-sm"
                                >
                                    {isExamMode ? 'ส่งข้อสอบ' : 'สรุปผล'}
                                </button>
                            </div>
                        </div>

                        <div className="max-w-6xl mx-auto mt-3 overflow-x-auto flex gap-2 pb-1 scrollbar-hide">
                            {Object.keys(examData).map(key => (
                                <button
                                    key={key}
                                    onClick={() => { setActivePart(key); window.scrollTo({ top: 0 }); }}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${activePart === key ? 'bg-white text-indigo-900 shadow-md transform scale-105' : 'bg-black/20 hover:bg-black/30 text-white/90'}`}
                                >
                                    {key.replace('part', 'Part ')}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2 border-b pb-4 border-gray-100">{examData[activePart].title}</h2>
                            <p className="text-gray-500 mb-8 bg-gray-50 p-3 rounded-lg border-l-4 border-indigo-400">{examData[activePart].instruction}</p>

                            <div className="space-y-8">
                                {examData[activePart].questions.map((qData, idx) => (
                                    <div key={`${activePart}-${idx}`} className={`relative group ${settings.showFurigana ? '' : 'hide-furigana'}`}>
                                        <div className="absolute -left-3 md:-left-8 top-1 font-bold text-gray-300 text-xl">{idx + 1}</div>
                                        
                                        {/* Question Render Logic */}
                                        <div className="mb-4">
                                            {examData[activePart].type === 'fill-in-inline' ? (
                                                <InlineQuestionRenderer 
                                                    questionText={qData.q}
                                                    delimiter={examData[activePart].delimiter}
                                                    questionId={`${activePart}-${idx}`}
                                                    userAnswers={userAnswers}
                                                    onAnswer={(slot, val) => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}-slot-${slot}`]: val}))}
                                                    showFurigana={settings.showFurigana}
                                                    fontSizeClass={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}
                                                    isDisabled={false}
                                                />
                                            ) : (
                                                <p className={`${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]} font-medium text-gray-800 jp-text leading-loose`}>
                                                    <RubifiedText text={qData.q} showFurigana={settings.showFurigana} />
                                                </p>
                                            )}
                                        </div>

                                        {/* Answer Input (for non-inline types) */}
                                        {examData[activePart].type === 'multiple-choice' && (
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {qData.options.map((opt, optIdx) => (
                                                    <button
                                                        key={optIdx}
                                                        onClick={() => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}`]: optIdx}))}
                                                        className={`p-3 text-left rounded-lg border-2 transition-all ${userAnswers[`${activePart}-${idx}`] === optIdx ? 'border-indigo-500 bg-indigo-50 text-indigo-900 font-medium shadow-sm' : 'border-gray-200 hover:border-gray-300 bg-white'}`}
                                                    >
                                                        <span className="mr-2 text-gray-400 font-bold">{String.fromCharCode(97 + optIdx)}.</span>
                                                        <span className={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}>
                                                            <RubifiedText text={opt} showFurigana={settings.showFurigana} />
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {examData[activePart].type === 'fill-in' && (
                                            <textarea
                                                value={userAnswers[`${activePart}-${idx}`] || ''}
                                                onChange={(e) => setUserAnswers(prev => ({...prev, [`${activePart}-${idx}`]: e.target.value}))}
                                                placeholder="พิมพ์คำตอบ..."
                                                rows="2"
                                                className={`w-full p-3 rounded-lg border-2 border-gray-200 focus:border-indigo-500 outline-none transition-colors bg-gray-50 focus:bg-white ${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]} jp-text`}
                                            />
                                        )}

                                        {/* Instant Answer (Practice Mode) */}
                                        {!isExamMode && (
                                            <PracticeAnswerReveal qData={qData} type={examData[activePart].type} settings={settings} />
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-between">
                             <button onClick={() => { const keys = Object.keys(examData); const prev = keys[keys.indexOf(activePart) - 1]; if(prev) { setActivePart(prev); window.scrollTo({top:0}); }}} disabled={activePart === 'part1'} className="px-6 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold disabled:opacity-50">&larr; ก่อนหน้า</button>
                             <button onClick={() => { const keys = Object.keys(examData); const next = keys[keys.indexOf(activePart) + 1]; if(next) { setActivePart(next); window.scrollTo({top:0}); }}} disabled={activePart === 'part7'} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 disabled:opacity-50">ถัดไป &rarr;</button>
                        </div>
                    </main>
                </div>
            );
        };

        const PracticeAnswerReveal = ({ qData, type, settings }) => {
            const [revealed, setRevealed] = useState(false);
            return (
                <div className="mt-3">
                    <button onClick={() => setRevealed(!revealed)} className="text-sm text-indigo-500 hover:text-indigo-700 font-medium flex items-center gap-1"><Icons.Eye /> {revealed ? 'ซ่อนเฉลย' : 'ดูเฉลย'}</button>
                    {revealed && (
                        <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg text-green-800 animate-in fade-in slide-in-from-top-1">
                            <span className="font-bold text-xs uppercase tracking-wide text-green-600 block mb-1">เฉลย:</span>
                            {type === 'multiple-choice' ? (
                                <span>ข้อ {String.fromCharCode(97 + qData.a)}: <strong>{qData.options[qData.a]}</strong></span>
                            ) : (
                                <span className={`jp-text font-medium ${['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}`}>{qData.a}</span>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const ResultSummary = ({ examData, userAnswers, onRestart }) => {
            const [settings, setSettings] = useState({ fontSize: 1, showFurigana: true });
            
            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8 text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">จบการทดสอบ / สรุปผล</h2>
                            <p className="text-gray-600 mb-6">กรุณาตรวจสอบคำตอบด้วยตนเองจากเฉลยด้านล่าง</p>
                            <button onClick={onRestart} className="px-8 py-3 bg-gray-800 hover:bg-black text-white rounded-lg font-bold shadow-lg transition-transform hover:-translate-y-1">กลับไปหน้าเมนูหลัก</button>
                        </div>

                        <div className="space-y-8">
                            {Object.entries(examData).map(([partKey, partData]) => (
                                <div key={partKey} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-100 px-6 py-4 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                                        <span>{partData.title}</span>
                                        <span className="text-xs bg-gray-200 px-2 py-1 rounded text-gray-500">{partData.questions.length} ข้อ</span>
                                    </div>
                                    <div className="p-6 space-y-6">
                                        {partData.questions.map((q, idx) => {
                                            const isMc = partData.type === 'multiple-choice';
                                            const uAns = userAnswers[`${partKey}-${idx}`];
                                            
                                            return (
                                                <div key={idx} className={`border-l-4 pl-4 ${isMc ? (uAns === q.a ? 'border-green-400' : 'border-red-400') : 'border-blue-300'} ${settings.showFurigana ? '' : 'hide-furigana'}`}>
                                                    <div className="mb-2">
                                                        {partData.type === 'fill-in-inline' ? (
                                                            <InlineQuestionRenderer 
                                                                questionText={q.q}
                                                                delimiter={partData.delimiter}
                                                                questionId={`${partKey}-${idx}`}
                                                                userAnswers={userAnswers}
                                                                onAnswer={() => {}} // Read-only
                                                                showFurigana={settings.showFurigana}
                                                                fontSizeClass={['text-base', 'text-xl', 'text-2xl'][settings.fontSize]}
                                                                isDisabled={true}
                                                            />
                                                        ) : (
                                                            <p className="font-medium text-gray-800 jp-text"><RubifiedText text={q.q} showFurigana={true} /></p>
                                                        )}
                                                    </div>
                                                    
                                                    {isMc ? (
                                                        <div className="text-sm mb-1">
                                                            <span className="text-gray-500">ตอบ: </span>
                                                            <span className={`font-medium ${uAns === q.a ? 'text-green-600' : 'text-red-600'}`}>
                                                                {uAns !== undefined ? <RubifiedText text={q.options[uAns]} showFurigana={true} /> : '-'}
                                                            </span>
                                                        </div>
                                                    ) : partData.type === 'fill-in' && (
                                                        <div className="text-sm mb-1 text-gray-600">
                                                            <span>ตอบ: {uAns || '-'}</span>
                                                        </div>
                                                    )}

                                                    <div className="text-sm bg-green-50 p-2 rounded text-green-800 inline-block mt-1">
                                                        <span className="font-bold">เฉลย: </span>
                                                        {isMc ? <RubifiedText text={q.options[q.a]} showFurigana={true} /> : q.a}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('menu');
            const [mode, setMode] = useState(null);
            const [currentExamData, setCurrentExamData] = useState(null);
            const [finalAnswers, setFinalAnswers] = useState({});

            const startExam = (selectedMode) => {
                let data = {};
                try {
                    if (selectedMode === 'practice_all') {
                        data = QUESTION_POOL;
                    } else {
                        // Randomize for Exam or Random Practice
                        Object.keys(QUESTION_POOL).forEach(key => {
                            const pool = QUESTION_POOL[key];
                            const count = EXAM_CONFIG.counts[key] || 5;
                            // Ensure we don't request more than available
                            const safeCount = Math.min(count, pool.questions.length);
                            data[key] = {
                                ...pool,
                                questions: getRandomQuestions(pool.questions, safeCount)
                            };
                        });
                    }
                    setCurrentExamData(data);
                    setMode(selectedMode);
                    setGameState('exam');
                    window.scrollTo(0, 0);
                } catch (error) {
                    console.error("Error starting exam:", error);
                    alert("เกิดข้อผิดพลาดในการเริ่มข้อสอบ กรุณาลองใหม่อีกครั้ง");
                }
            };

            const finishExam = (answers, isTimeOut) => {
                setFinalAnswers(answers);
                setGameState('result');
                if (isTimeOut) alert("หมดเวลาการสอบ!");
                window.scrollTo(0, 0);
            };

            if (gameState === 'menu') return <MenuScreen onStart={startExam} />;
            if (gameState === 'exam') return <ExamInterface mode={mode} examData={currentExamData} onFinish={finishExam} onHome={() => setGameState('menu')} />;
            if (gameState === 'result') return <ResultSummary examData={currentExamData} userAnswers={finalAnswers} onRestart={() => setGameState('menu')} />;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
