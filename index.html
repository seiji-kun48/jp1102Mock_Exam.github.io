<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPN1102 Exam Simulator (Furigana Edition)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Noto Sans Thai & Noto Sans JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .jp-text { font-family: 'Noto Sans JP', sans-serif; line-height: 1.8; }
        
        /* Ruby (Furigana) Styling */
        ruby { font-family: 'Noto Sans JP', sans-serif; ruby-align: center; }
        rt { font-size: 0.6em; color: #6b7280; font-weight: normal; }
        
        /* Hide Furigana Class */
        .hide-furigana rt { display: none; }
        .hide-furigana ruby { ruby-position: unset; }

        /* Prevent Selection in Exam Mode */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- CONFIGURATION ---
        const EXAM_CONFIG = {
            duration: 120 * 60, // 2 ชั่วโมง
            counts: {
                part1: 15, part2: 5, part3: 7, part4: 5, 
                part5: 12, part6: 15, part7: 12
            }
        };

        // --- Question Pool (With Furigana Syntax: Kanji{reading}) ---
        const QUESTION_POOL = {
            part1: {
                title: "Part 1: เติมคำช่วย (Joshi)",
                instruction: "จงเติมคำช่วยที่ถูกต้องลงในช่องว่าง",
                type: "fill-in",
                questions: [
                    { q: "あれ（　）佐藤{さとう}さん（　）くれたワインです。", a: "あれ（は）佐藤さん（が）くれたワインです。" },
                    { q: "時間{じかん}（　）あったら、京都{きょうと}（　）旅行{りょこう}したいです。", a: "時間（が）あったら、京都（へ/に）旅行したいです。" },
                    { q: "父{ちち}は私{わたし}（　）時計{とけい}（　）買{か}ってくれました。", a: "父は私（に）時計（を）買ってくれました。" },
                    { q: "私{わたし}（　）家族{かぞく}（　）日本{にほん}へ行{い}きたいです。", a: "私（は）家族（と）日本へ行きたいです。" },
                    { q: "ここ（　）タバコ（　）吸{す}ってはいけません。", a: "ここ（で）タバコ（を）吸ってはいけません。" },
                    { q: "先生{せんせい}（　）聞{き}きました（　）、テストは明日{あした}だそうです。", a: "先生（に）聞きました（が）、テストは明日だそうです。" },
                    { q: "京都駅{きょうとえき}（　）電車{でんしゃ}（　）乗{の}ります。", a: "京都駅（で）電車（に）乗ります。" },
                    { q: "電車{でんしゃ}（　）降{お}りて、バス（　）乗{の}り換{か}えます。", a: "電車（を）降りて、バス（に）乗り換えます。" },
                    { q: "友達{ともだち}（　）約束{やくそく}（　）ありますから、帰{かえ}ります。", a: "友達（と）約束（が）ありますから、帰ります。" },
                    { q: "この図{ず}（　）とおりに、折{お}って（　）ください。", a: "この図（の）とおりに、折って（ください）。" },
                    { q: "砂糖{さとう}（　）入{い}れない（　）、おいしくないです。", a: "砂糖（を）入れない（と）、おいしくないです。" },
                    { q: "雨{あめ}（　）降{ふ}っても、洗濯{せんたく}（　）します。", a: "雨（が）降っても、洗濯（を）します。" },
                    { q: "部長{ぶちょう}（　）資料{しりょう}（　）送{おく}っておきました。", a: "部長（に）資料（を）送っておきました。" },
                    { q: "壁{かべ}（　）カレンダー（　）掛{か}けてあります。", a: "壁（に）カレンダー（が）掛けてあります。" },
                    { q: "遅刻{ちこく}した理由{りゆう}（　）先生{せんせい}（　）説明{せつめい}しました。", a: "遅刻した理由（を）先生（に）説明しました。" },
                    { q: "週末{しゅうまつ}（　）海{うみ}（　）行{い}こうと思{おも}っています。", a: "週末（は/に）海（へ/に）行こうと思っています。" },
                    { q: "明日{あした}（　）雨{あめ}（　）降{ふ}るかもしれません。", a: "明日（は）雨（が）降るかもしれません。" },
                    { q: "駅{えき}まで君{きみ}（　）迎{むか}え（　）行{い}ってあげます。", a: "駅まで君（を）迎え（に）行ってあげます。" },
                    { q: "この漢字{かんじ}（　）読{よ}み方{かた}（　）教{おし}えてください。", a: "この漢字（の）読み方（を）教えてください。" },
                    { q: "黒{くろ}いシャツ（　）着{き}ている人{ひと}（　）誰{だれ}ですか。", a: "黒いシャツ（を）着ている人（は）誰ですか。" }
                ]
            },
            part2: {
                title: "Part 2: ผันรูปคำกริยา/คำศัพท์",
                instruction: "เปลี่ยนคำในวงเล็บให้อยู่ในรูปที่ถูกต้อง",
                type: "fill-in",
                questions: [
                    { q: "（行{い}きます → _______ ）とき、「行{い}ってまいります」と言{い}います。", a: "出かける (Dict form) / 行く" },
                    { q: "あそこで（歌{うた}っています → _______ ）人{ひと}は誰{だれ}ですか。", a: "歌っている" },
                    { q: "これは母{はは}が（作{つく}りました → _______ ）ケーキです。", a: "作った" },
                    { q: "もっと（勉強{べんきょう}します → _______ ）ほうがいいですよ。", a: "勉強した" },
                    { q: "明日{あした}は（雪{ゆき}です → _______ ）かもしれません。", a: "雪" },
                    { q: "この本{ほん}は（読{よ}みます → _______ ）やすいです。", a: "読み" },
                    { q: "（暑{あつ}いです → _______ ）し、喉{のど}も乾{かわ}きました。", a: "暑い" },
                    { q: "窓{まど}が（割{わ}ります → _______ ）います。", a: "割れて" },
                    { q: "（飲{の}みます → _______ ）すぎました。", a: "飲み" },
                    { q: "（聞{き}きます → _______ ）とおりに、書{か}いてください。", a: "聞いた" }
                ]
            },
            part3: {
                title: "Part 3: ตอบคำถาม (Q&A)",
                instruction: "ตอบคำถามให้สมบูรณ์",
                type: "fill-in",
                questions: [
                    { q: "誰{だれ}に日本語{にほんご}を教{おし}えてもらいましたか。", a: "日本人の先生に教えてもらいました。" },
                    { q: "財布{さいふ}を落{お}としたとき、どうしますか。", a: "交番へ行きます。" },
                    { q: "日本{にほん}へ行{い}ったことがありますか。", a: "はい、行ったことがあります。 / いいえ、行ったことがありません。" },
                    { q: "日曜日{にちようび}は何{なに}をしたり、何{なに}をしたりしますか。", a: "テニスをしたり、映画を見たりします。" },
                    { q: "将来{しょうらい}、何{なん}になりたいですか。", a: "医者になりたいです。" },
                    { q: "今{いま}の首相{しゅしょう}についてどう思{おも}いますか。", a: "いい人だと思います。 / よく働くと思います。" },
                    { q: "会議{かいぎ}の前{まえ}に、何{なに}をしておかなければなりませんか。", a: "資料をコピーしておかなければなりません。" },
                    { q: "どうして昨日{きのう}学校{がっこう}を休{やす}みましたか。", a: "熱があったんです。" },
                    { q: "もう昼{ひる}ご飯{はん}を食{た}べましたか。", a: "いいえ、まだ食べていません。" },
                    { q: "週末{しゅうまつ}、天気{てんき}がよかったら、どこへ行{い}きたいですか。", a: "海へ行きたいです。" }
                ]
            },
            part4: {
                title: "Part 4: แยกประโยค",
                instruction: "ระบุประโยคหลัก (Main) และส่วนขยาย (Modifier)",
                type: "fill-in",
                questions: [
                    { q: "私{わたし}は 朝{あさ}ご飯{はん}を食{た}べる 時間{じかん}がありません。", a: "Main: 私は時間がありません。 / Sub: 朝ごはんを食べる。" },
                    { q: "京都{きょうと}へ行{い}く人{ひと}は ミラーさんです。", a: "Main: 人はミラーさんです。 / Sub: 京都へ行く。" },
                    { q: "私{わたし}が住{す}んでいるアパートは便利{べんり}です。", a: "Main: アパートは便利です。 / Sub: 私が住んでいる。" },
                    { q: "父{ちち}が生{う}まれた所{ところ}は北海道{ほっかいどう}です。", a: "Main: 所は北海道です。 / Sub: 父が生まれた。" },
                    { q: "昨日{きのう}習{なら}った言葉{ことば}を忘{わす}れました。", a: "Main: 言葉を忘れました。 / Sub: 昨日習った。" },
                    { q: "彼{かれ}が来{こ}ない理由{りゆう}を知{し}っていますか。", a: "Main: 理由を知っていますか。 / Sub: 彼が来ない。" },
                    { q: "母{はは}が作{つく}った料理{りょうり}はおいしいです。", a: "Main: 料理はおいしいです。 / Sub: 母が作った。" },
                    { q: "帽子{ぼうし}をかぶっている人{ひと}は田中{たなか}さんです。", a: "Main: 人は田中さんです。 / Sub: 帽子をかぶっている。" }
                ]
            },
            part5: {
                title: "Part 5: แก้ไขประโยค (Error Correction)",
                instruction: "แก้ไขประโยคที่ผิดไวยากรณ์ให้ถูกต้อง",
                type: "fill-in",
                questions: [
                    { q: "雨{あめ}が降{ふ}ると、出{で}かけません。", a: "雨が降ったら、出かけません。" },
                    { q: "安{やす}いで、おいしいです。", a: "安くて、おいしいです。" },
                    { q: "私{わたし}は花{はな}に水{みず}をくれました。", a: "あげました / やりました" },
                    { q: "日本{にほん}へ行{い}ったことがありません。", a: "日本へ行ったことがありません。（Correct） / 行った → 行く (Error if context implies never)" },
                    { q: "明日{あした}、雨{あめ}が降{ふ}らないと思{おも}います。", a: "明日、雨が降らないと思います。（Correct）" },
                    { q: "頭{あたま}が痛{いた}い、帰{かえ}ってもいいですか。", a: "頭が痛いので／痛いですから、帰ってもいいですか。" },
                    { q: "この本{ほん}は読{よ}みやすいです。", a: "この本は読みやすいです。（Correct）" },
                    { q: "窓{まど}を開{あ}けています。", a: "窓が開いています。（State） / 窓を開けてあります。" },
                    { q: "財布{さいふ}を落{お}としてしまいました。", a: "財布を落としてしまいました。（Correct）" },
                    { q: "試験{しけん}に合格{ごうかく}するように、勉強{べんきょう}しています。", a: "試験に合格するように、勉強しています。（Correct）" }
                ]
            },
            part6: {
                title: "Part 6: การแปล (Translation)",
                instruction: "แปลประโยคต่อไปนี้เป็นภาษาญี่ปุ่น/ไทย",
                type: "fill-in",
                questions: [
                    { q: "พรุ่งนี้ ถ้าฝนตก จะไม่ออกไปข้างนอก", a: "明日、雨が降ったら、出かけません。" },
                    { q: "คุณมิลเลอร์พูดว่า \"พรุ่งนี้จะไปโตเกียว\"", a: "ミラーさんは「明日、東京へ行きます」と言いました。" },
                    { q: "กรุณาอย่าลืมร่ม", a: "傘を忘れないでください。" },
                    { q: "เคยปีนภูเขาไฟฟูจิไหม", a: "富士山に登ったことがありますか。" },
                    { q: "ช่วงนี้ยุ่ง ก็เลยไม่ได้ไปไหนเลย", a: "最近忙しいので／忙しいから、どこも行きませんでした。" },
                    { q: "ฉันให้ดอกไม้แฟน (ผู้หญิง)", a: "私は彼女に花をあげました。" },
                    { q: "ได้รับช็อกโกแลตจากใคร", a: "誰に／から チョコレートをもらいましたか。" },
                    { q: "ก่อนนอน แปรงฟัน", a: "寝る前に、歯を磨きます。" },
                    { q: "หลังจากกินข้าว จะดื่มกาแฟ", a: "ご飯を食べた後で、コーヒーを飲みます。" },
                    { q: "ช่วยปิดประตูหน่อยได้ไหม", a: "ドアを閉めてくれませんか／いただけませんか。" },
                    { q: "ถ้ากดปุ่มนี้ เงินทอนจะออกมา", a: "このボタンを押すと、お釣りが出ます。" },
                    { q: "ดูเหมือนฝนจะตก", a: "雨が降りそうです。" },
                    { q: "ได้ยินว่าพรุ่งนี้อากาศจะเย็น", a: "明日は涼しくなるそうです。" }
                ]
            },
            part7: {
                title: "Part 7: ปรนัย (Multiple Choice)",
                instruction: "เลือกข้อที่ถูกต้องที่สุด",
                type: "multiple-choice",
                questions: [
                    { q: "（　）雨{あめ}が降{ふ}ったら、行{い}きません。", options: ["もし", "いくら", "たぶん", "ぜひ"], a: 0 },
                    { q: "彼{かれ}は（　）来{く}ると思{おも}います。", options: ["たぶん", "きっと", "もし", "いくら"], a: 1 },
                    { q: "（　）高{たか}くても、買{か}います。", options: ["もし", "たぶん", "いくら", "ぜひ"], a: 2 },
                    { q: "（　）来{こ}ないと思{おも}います。", options: ["もしかしたら", "きっと", "ぜひ", "いろいろ"], a: 0 },
                    { q: "道{みち}が（　）なりました。", options: ["複雑", "複雑に", "複雑な", "複雑く"], a: 1 },
                    { q: "（　）お祈{いの}りしましたか。", options: ["一度", "一度も", "一回も", "いつ"], a: 1 },
                    { q: "お湯{ゆ}が（　）。", options: ["出します", "出ます", "おります", "おろします"], a: 1 },
                    { q: "音{おと}を（　）します。", options: ["大きい", "大きく", "大きに", "大きくて"], a: 1 },
                    { q: "（　）遊{あそ}びに来{き}てください。", options: ["きっと", "ぜひ", "たぶん", "もし"], a: 1 },
                    { q: "約束{やくそく}の時間{じかん}に（　）、どうしますか。", options: ["間に合わなかったら", "間に合わないと", "間に合わなくて", "間に合う"], a: 0 },
                    { q: "図書館{としょかん}で本{ほん}を（　）とき、カードが要{い}ります。", options: ["借りた", "借りる", "借りて", "借ります"], a: 1 },
                    { q: "砂糖{さとう}を（　）なくてもいいですよ。", options: ["入れ", "入ら", "入る", "入って"], a: 0 },
                    { q: "窓{まど}が（　）います。", options: ["閉めて", "閉まって", "閉め", "閉まり"], a: 1 },
                    { q: "電車{でんしゃ}に（　）忘{わす}れました。", options: ["傘を", "傘が", "傘で", "傘に"], a: 0 },
                    { q: "壁{かべ}に絵{え}が（　）あります。", options: ["かけ", "かけて", "かかって", "かかり"], a: 1 }
                ]
            }
        };

        // --- ICONS ---
        const Icons = {
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>,
            Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        };

        // --- HELPER FUNCTIONS ---
        const getRandomQuestions = (questions, count) => {
            if (!questions) return [];
            const shuffled = [...questions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        };

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // --- COMPONENTS ---

        // 1. Ruby Text Parser Component
        // Converts "漢字{かんじ}" to <ruby>漢字<rt>かんじ</rt></ruby>
        const RubifiedText = ({ text, showFurigana }) => {
            if (!text) return null;
            
            // Regex to match Kanji{Reading}
            const regex = /([\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3038-\u303B\u3400-\u4DB5\u4E00-\u9FCC\uF900-\uFA6D\uFA70-\uFAD9]+)\{([^\}]+)\}/g;
            
            const elements = [];
            let lastIndex = 0;
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                // Add text before match
                if (match.index > lastIndex) {
                    elements.push(text.substring(lastIndex, match.index));
                }
                // Add ruby element
                elements.push(
                    <ruby key={match.index}>
                        {match[1]}
                        <rt className={showFurigana ? '' : 'hidden'}>{match[2]}</rt>
                    </ruby>
                );
                lastIndex = regex.lastIndex;
            }
            // Add remaining text
            if (lastIndex < text.length) {
                elements.push(text.substring(lastIndex));
            }

            return <>{elements}</>;
        };

        // 2. Settings Controls
        const SettingsBar = ({ settings, updateSettings, isExamMode }) => {
            return (
                <div className="bg-white/90 backdrop-blur-sm shadow-sm border-b border-gray-200 px-4 py-2 flex items-center justify-end gap-4 text-sm sticky top-[60px] z-40">
                    {/* Font Size Control */}
                    <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                        <button 
                            onClick={() => updateSettings({ fontSize: Math.max(0, settings.fontSize - 1) })}
                            className="w-8 h-8 flex items-center justify-center hover:bg-white rounded shadow-sm text-gray-600 font-bold"
                            title="ลดขนาดตัวอักษร"
                        >
                            A-
                        </button>
                        <span className="text-gray-500 w-4 text-center">{settings.fontSize + 1}</span>
                        <button 
                            onClick={() => updateSettings({ fontSize: Math.min(2, settings.fontSize + 1) })}
                            className="w-8 h-8 flex items-center justify-center hover:bg-white rounded shadow-sm text-gray-600 font-bold"
                            title="เพิ่มขนาดตัวอักษร"
                        >
                            A+
                        </button>
                    </div>

                    {/* Furigana Toggle */}
                    <button 
                        onClick={() => updateSettings({ showFurigana: !settings.showFurigana })}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all border ${
                            settings.showFurigana 
                                ? 'bg-indigo-50 border-indigo-200 text-indigo-700' 
                                : 'bg-gray-50 border-gray-200 text-gray-500'
                        }`}
                    >
                        <span className="text-xs font-bold font-jp">ふりがな</span>
                        <div className={`w-8 h-4 rounded-full relative transition-colors ${settings.showFurigana ? 'bg-indigo-500' : 'bg-gray-300'}`}>
                            <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-transform ${settings.showFurigana ? 'left-4.5 translate-x-1' : 'left-0.5'}`}></div>
                        </div>
                    </button>
                </div>
            );
        };

        // 3. MENU SCREEN
        const MenuScreen = ({ onStart }) => (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-indigo-800 p-4">
                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full flex flex-col md:flex-row">
                    
                    {/* Exam Mode Card */}
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors border-b md:border-b-0 md:border-r border-gray-200 flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 text-red-600 group-hover:scale-110 transition-transform">
                            <Icons.Lock />
                        </div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดสอบจริง</h2>
                        <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>จับเวลา 2 ชั่วโมง</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>ห้ามดูเฉลย</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>สุ่มข้อสอบตามแนวข้อสอบจริง</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-full"></span>ห้ามคัดลอก (Copy/Paste)</li>
                        </ul>
                        <button onClick={() => onStart('exam')} className="mt-auto px-8 py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg w-full transition-all transform hover:-translate-y-1">
                            เริ่มสอบ
                        </button>
                    </div>

                    {/* Practice Mode Card */}
                    <div className="flex-1 p-8 md:p-12 hover:bg-gray-50 transition-colors flex flex-col items-center text-center group">
                        <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 group-hover:scale-110 transition-transform">
                            <Icons.Unlock />
                        </div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">โหมดฝึกฝน</h2>
                         <ul className="text-gray-600 text-left space-y-3 mb-8 text-sm font-light">
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ไม่มีเวลาจำกัด</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ดูเฉลยได้ทันที</li>
                            <li className="flex items-center gap-2"><span className="w-2 h-2 bg-green-500 rounded-full"></span>คัดลอกโจทย์ได้</li>
                        </ul>
                        <div className="mt-auto w-full space-y-3">
                            <button onClick={() => onStart('practice_all')} className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold w-full transition-colors">
                                ฝึกทำทุกข้อในคลัง
                            </button>
                            <button onClick={() => onStart('practice_random')} className="px-8 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold w-full transition-colors">
                                ฝึกแบบสุ่ม (เหมือนสอบ)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // 4. EXAM INTERFACE
        const ExamInterface = ({ mode, examData, onFinish }) => {
            const [activePart, setActivePart] = useState('part1');
            const [userAnswers, setUserAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(EXAM_CONFIG.duration);
            const [settings, setSettings] = useState({
                fontSize: 1, // 0=sm, 1=base, 2=lg
                showFurigana: true
            });
            const timerRef = useRef(null);

            const isExamMode = mode === 'exam';

            // Timer Logic
            useEffect(() => {
                if (isExamMode) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timerRef.current);
                                onFinish(userAnswers, true); // Auto finish
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [isExamMode, onFinish, userAnswers]);

            // Anti-Cheat
            useEffect(() => {
                if (isExamMode) {
                    const preventDefault = (e) => e.preventDefault();
                    document.addEventListener('contextmenu', preventDefault);
                    document.addEventListener('copy', preventDefault);
                    document.addEventListener('selectstart', preventDefault);
                    return () => {
                        document.removeEventListener('contextmenu', preventDefault);
                        document.removeEventListener('copy', preventDefault);
                        document.removeEventListener('selectstart', preventDefault);
                    };
                }
            }, [isExamMode]);

            return (
                <div className={`min-h-screen pb-20 ${isExamMode ? 'no-select' : ''}`}>
                    {/* Header */}
                    <header className={`${isExamMode ? 'bg-red-900' : 'bg-indigo-700'} text-white p-3 sticky top-0 z-50 shadow-md transition-colors`}>
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 className="font-bold text-lg flex items-center gap-2">
                                {isExamMode ? <Icons.Lock /> : <Icons.Book />}
                                <span className="hidden sm:inline font-medium">{isExamMode ? 'การสอบปลายภาค (จำลอง)' : 'โหมดฝึกฝน'}</span>
                            </h1>
                            
                            {isExamMode && (
                                <div className={`flex items-center gap-2 font-mono text-xl font-bold px-4 py-1 rounded-lg ${timeLeft < 300 ? 'bg-red-600 animate-pulse' : 'bg-black/30'}`}>
                                    <Icons.Clock /> {formatTime(timeLeft)}
                                </div>
                            )}

                            <button 
                                onClick={() => {
                                    if(window.confirm('ต้องการส่งคำตอบและดูผลลัพธ์หรือไม่?')) {
                                        onFinish(userAnswers, false);
                                    }
                                }}
                                className="bg-white text-indigo-900 hover:bg-gray-100 px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition-all"
                            >
                                {isExamMode ? 'ส่งข้อสอบ' : 'สรุปผล'}
                            </button>
                        </div>

                        {/* Part Navigation */}
                        <div className="max-w-6xl mx-auto mt-3 overflow-x-auto flex gap-2 pb-1 scrollbar-hide">
                            {Object.keys(examData).map(key => (
                                <button
                                    key={key}
                                    onClick={() => {
                                        setActivePart(key);
                                        window.scrollTo({ top: 0 });
                                    }}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${
                                        activePart === key 
                                            ? 'bg-white text-indigo-900 shadow-md transform scale-105' 
                                            : 'bg-black/20 hover:bg-black/30 text-white/90'
                                    }`}
                                >
                                    {key.replace('part', 'Part ')}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* Settings Bar */}
                    <SettingsBar 
                        settings={settings} 
                        updateSettings={(newSets) => setSettings(prev => ({...prev, ...newSets}))} 
                        isExamMode={isExamMode}
                    />

                    {/* Content */}
                    <main className="max-w-4xl mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 mb-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2 border-b pb-4 border-gray-100">
                                {examData[activePart].title}
                            </h2>
                            <p className="text-gray-500 mb-8 bg-gray-50 p-3 rounded-lg border-l-4 border-indigo-400">
                                {examData[activePart].instruction}
                            </p>

                            <div className="space-y-8">
                                {examData[activePart].questions.map((qData, idx) => (
                                    <QuestionItem 
                                        key={`${activePart}-${idx}`}
                                        idx={idx}
                                        partKey={activePart}
                                        data={qData}
                                        type={examData[activePart].type}
                                        answer={userAnswers[`${activePart}-${idx}`] || ''}
                                        onAnswer={(val) => setUserAnswers(prev => ({ ...prev, [`${activePart}-${idx}`]: val }))}
                                        showInstantAnswer={!isExamMode}
                                        settings={settings}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Navigation Footer */}
                        <div className="flex justify-between">
                             <button
                                onClick={() => {
                                    const keys = Object.keys(examData);
                                    const prev = keys[keys.indexOf(activePart) - 1];
                                    if(prev) { setActivePart(prev); window.scrollTo({top:0}); }
                                }}
                                disabled={activePart === 'part1'}
                                className="px-6 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold disabled:opacity-50"
                            >
                                &larr; ก่อนหน้า
                            </button>
                            <button
                                onClick={() => {
                                    const keys = Object.keys(examData);
                                    const next = keys[keys.indexOf(activePart) + 1];
                                    if(next) { setActivePart(next); window.scrollTo({top:0}); }
                                }}
                                disabled={activePart === 'part7'}
                                className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 disabled:opacity-50"
                            >
                                ถัดไป &rarr;
                            </button>
                        </div>
                    </main>
                </div>
            );
        };

        const QuestionItem = ({ idx, partKey, data, type, answer, onAnswer, showInstantAnswer, settings }) => {
            const [revealed, setRevealed] = useState(false);
            
            // Dynamic classes based on font size setting
            const fontSizes = ['text-base', 'text-xl', 'text-2xl'];
            const currentSize = fontSizes[settings.fontSize];

            return (
                <div className={`relative group ${settings.showFurigana ? '' : 'hide-furigana'}`}>
                    <div className="absolute -left-3 md:-left-8 top-1 font-bold text-gray-300 text-xl">{idx + 1}</div>
                    <div className="mb-4">
                        <p className={`${currentSize} font-medium text-gray-800 jp-text leading-loose`}>
                            <RubifiedText text={data.q} showFurigana={settings.showFurigana} />
                        </p>
                    </div>

                    {type === 'multiple-choice' ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {data.options.map((opt, optIdx) => (
                                <button
                                    key={optIdx}
                                    onClick={() => onAnswer(optIdx)}
                                    className={`p-3 text-left rounded-lg border-2 transition-all ${
                                        answer === optIdx 
                                            ? 'border-indigo-500 bg-indigo-50 text-indigo-900 font-medium shadow-sm' 
                                            : 'border-gray-200 hover:border-gray-300 bg-white'
                                    }`}
                                >
                                    <span className="mr-2 text-gray-400 font-bold">{String.fromCharCode(97 + optIdx)}.</span>
                                    <span className={currentSize}>
                                        <RubifiedText text={opt} showFurigana={settings.showFurigana} />
                                    </span>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <textarea
                            value={answer}
                            onChange={(e) => onAnswer(e.target.value)}
                            placeholder="พิมพ์คำตอบ..."
                            rows="2"
                            className={`w-full p-3 rounded-lg border-2 border-gray-200 focus:border-indigo-500 outline-none transition-colors bg-gray-50 focus:bg-white ${currentSize} jp-text`}
                        />
                    )}

                    {/* Instant Answer Reveal (Practice Mode Only) */}
                    {showInstantAnswer && (
                        <div className="mt-3">
                            <button 
                                onClick={() => setRevealed(!revealed)}
                                className="text-sm text-indigo-500 hover:text-indigo-700 font-medium flex items-center gap-1"
                            >
                                <Icons.Eye /> {revealed ? 'ซ่อนเฉลย' : 'ดูเฉลย'}
                            </button>
                            
                            {revealed && (
                                <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg text-green-800 animate-in fade-in slide-in-from-top-1">
                                    <span className="font-bold text-xs uppercase tracking-wide text-green-600 block mb-1">เฉลย:</span>
                                    {type === 'multiple-choice' ? (
                                        <span>
                                            ข้อ {String.fromCharCode(97 + data.a)}: <strong>{data.options[data.a]}</strong>
                                        </span>
                                    ) : (
                                        <span className={`jp-text font-medium ${currentSize}`}>{data.a}</span>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // 5. RESULT SUMMARY
        const ResultSummary = ({ examData, userAnswers, onRestart }) => {
            let mcScore = 0;
            let mcTotal = 0;
            if (examData.part7) {
                mcTotal = examData.part7.questions.length;
                examData.part7.questions.forEach((q, idx) => {
                    if (userAnswers[`part7-${idx}`] === q.a) mcScore++;
                });
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8 text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">สรุปผลการทำข้อสอบ</h2>
                            
                            <div className="inline-block bg-indigo-50 px-8 py-6 rounded-2xl border border-indigo-100">
                                <p className="text-gray-500 uppercase tracking-wide text-sm font-bold mb-2">คะแนน Part 7 (ปรนัย)</p>
                                <div className="text-5xl font-bold text-indigo-600 mb-1">
                                    {mcScore} <span className="text-2xl text-gray-400">/ {mcTotal}</span>
                                </div>
                                <div className="w-full bg-gray-200 h-2 rounded-full mt-2 overflow-hidden">
                                    <div className="bg-indigo-500 h-full" style={{ width: `${(mcScore/mcTotal)*100}%` }}></div>
                                </div>
                            </div>
                            
                            <p className="mt-6 text-gray-600">
                                สำหรับ Part 1-6 โปรดตรวจสอบคำตอบของท่านเทียบกับเฉลยด้านล่าง
                            </p>
                            
                            <button 
                                onClick={onRestart}
                                className="mt-8 px-8 py-3 bg-gray-800 hover:bg-black text-white rounded-lg font-bold shadow-lg transition-transform hover:-translate-y-1"
                            >
                                กลับไปหน้าเมนูหลัก
                            </button>
                        </div>

                        <div className="space-y-8">
                            {Object.entries(examData).map(([partKey, partData]) => (
                                <div key={partKey} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="bg-gray-100 px-6 py-4 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                                        <span>{partData.title}</span>
                                        <span className="text-xs bg-gray-200 px-2 py-1 rounded text-gray-500">
                                            {partData.questions.length} ข้อ
                                        </span>
                                    </div>
                                    <div className="p-6 space-y-6">
                                        {partData.questions.map((q, idx) => {
                                            const uAns = userAnswers[`${partKey}-${idx}`];
                                            const isMc = partData.type === 'multiple-choice';
                                            const isCorrect = isMc && uAns === q.a;

                                            return (
                                                <div key={idx} className={`border-l-4 pl-4 ${isMc ? (isCorrect ? 'border-green-400' : 'border-red-400') : 'border-blue-300'}`}>
                                                    <p className="font-medium text-gray-800 mb-2 jp-text">
                                                        <RubifiedText text={q.q} showFurigana={true} />
                                                    </p>
                                                    
                                                    <div className="text-sm mb-1">
                                                        <span className="text-gray-500">ตอบ: </span>
                                                        <span className={`font-medium ${isMc ? (isCorrect ? 'text-green-600' : 'text-red-600') : 'text-gray-800'}`}>
                                                            {isMc 
                                                                ? (uAns !== undefined ? <RubifiedText text={q.options[uAns]} showFurigana={true} /> : '-') 
                                                                : (uAns || '-')}
                                                        </span>
                                                    </div>

                                                    <div className="text-sm bg-green-50 p-2 rounded text-green-800 inline-block">
                                                        <span className="font-bold">เฉลย: </span>
                                                        {isMc ? <RubifiedText text={q.options[q.a]} showFurigana={true} /> : q.a}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // MAIN APP CONTAINER
        const App = () => {
            const [gameState, setGameState] = useState('menu'); // menu, exam, result
            const [mode, setMode] = useState(null); // exam, practice_all, practice_random
            const [currentExamData, setCurrentExamData] = useState(null);
            const [finalAnswers, setFinalAnswers] = useState({});

            const startExam = (selectedMode) => {
                let data = {};
                
                if (selectedMode === 'practice_all') {
                    data = QUESTION_POOL;
                } else {
                    Object.keys(QUESTION_POOL).forEach(key => {
                        const pool = QUESTION_POOL[key];
                        const count = EXAM_CONFIG.counts[key] || 5;
                        data[key] = {
                            ...pool,
                            questions: getRandomQuestions(pool.questions, count)
                        };
                    });
                }

                setCurrentExamData(data);
                setMode(selectedMode);
                setGameState('exam');
                window.scrollTo(0, 0);
            };

            const finishExam = (answers, isTimeOut) => {
                setFinalAnswers(answers);
                setGameState('result');
                if (isTimeOut) alert("หมดเวลาการสอบ!");
                window.scrollTo(0, 0);
            };

            if (gameState === 'menu') return <MenuScreen onStart={startExam} />;
            if (gameState === 'exam') return <ExamInterface mode={mode} examData={currentExamData} onFinish={finishExam} />;
            if (gameState === 'result') return <ResultSummary examData={currentExamData} userAnswers={finalAnswers} onRestart={() => setGameState('menu')} />;
            
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
